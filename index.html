<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Dashboard</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0?external=react",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.24.4/babel.min.js"></script>
    
    <style>
        /* Custom Scrollbar agar lebih rapi */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .recharts-wrapper { margin: 0 auto; }
        /* Animasi Fade In */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <!-- Tempat Aplikasi React akan Muncul -->
    <div id="root"></div>

    <!-- 4. Kode Aplikasi -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ComposedChart, BarChart, LineChart, Line, Bar, XAxis, YAxis, 
          CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine, 
          Legend, LabelList, PieChart, Pie 
        } from 'recharts';
        import { 
          ClipboardList, Save, Trash2, TrendingUp, AlertCircle, CheckCircle, 
          Package, Target, LayoutDashboard, Settings, Filter, Truck, Loader2, 
          FileSpreadsheet, UploadCloud, Briefcase, ShoppingBag, Layers, 
          ChevronDown, PieChart as PieIcon, Warehouse, Search, Table, 
          AlertTriangle, RotateCcw, Database, Lock, LogOut, User
        } from 'lucide-react';
        import { initializeApp } from "firebase/app";
        import { 
          getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "firebase/auth";
        import { 
          getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, 
          query, writeBatch 
        } from "firebase/firestore";

        // --- KONFIGURASI FIREBASE ---
        const userProvidedConfig = {
          apiKey: "AIzaSyDZF4CJLz9WFrbrv0EdSUqdpfyEPuPRAT4",
          authDomain: "laporan-eecfd.firebaseapp.com",
          projectId: "laporan-eecfd",
          storageBucket: "laporan-eecfd.firebasestorage.app",
          messagingSenderId: "789866197217",
          appId: "1:789866197217:web:b26378b445fa2c501fc7a0"
        };

        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : userProvidedConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'stock-dashboard-default';
        const __initial_auth_token = window.__initial_auth_token || '';

        // --- UI COMPONENTS ---
        const Card = ({ children, className = "" }) => (
          <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
            {children}
          </div>
        );

        const StatCard = ({ title, value, subtext, icon: Icon, colorClass, percentage }) => (
          <Card>
            <div className="flex items-start justify-between">
              <div>
                <p className="text-slate-500 text-sm font-medium mb-1">{title}</p>
                <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                {percentage !== undefined && (
                  <div className="flex items-center gap-2 mt-1.5 mb-1">
                    <span className={`text-xs font-bold px-2 py-0.5 rounded-md bg-opacity-10 border ${colorClass.replace('text-', 'bg-')} ${colorClass.replace('text-', 'border-')} ${colorClass}`}>
                      {percentage}%
                    </span>
                    <span className="text-[10px] text-slate-400 font-medium uppercase tracking-wide">Level</span>
                  </div>
                )}
                {subtext && <p className={`text-xs ${percentage ? 'mt-0' : 'mt-1'} ${colorClass} opacity-80`}>{subtext}</p>}
              </div>
              <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10`}>
                <Icon size={24} className={colorClass.replace('text-', 'text-opacity-100 ')} />
              </div>
            </div>
          </Card>
        );

        // --- MAIN APPLICATION COMPONENT ---
        function App() {
          // --- KONSTANTA SISTEM ---
          const TARGET_ACCURACY = 99.98;
          const DAMAGE_TOLERANCE = 0.50; 
          const TARGET_PALLET_QTY = 1400; 
          const TARGET_PALLET_PCT = 35; 

          // --- STATE MANAGEMENT ---
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [adminSection, setAdminSection] = useState('stock'); 
          const [filterPeriod, setFilterPeriod] = useState('Semua');
          const [searchTerm, setSearchTerm] = useState('');
          const [isProcessing, setIsProcessing] = useState(false);
          
          // --- ADMIN AUTH STATE ---
          const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
          const [loginUser, setLoginUser] = useState('');
          const [loginPass, setLoginPass] = useState('');
          const [loginError, setLoginError] = useState('');
          
          // Data Collections
          const [data, setData] = useState([]);
          const [outboundData, setOutboundData] = useState([]);
          const [utilizationData, setUtilizationData] = useState([]);
          const [damageData, setDamageData] = useState([]);
          const [palletReturnData, setPalletReturnData] = useState([]); 
          const [masterData, setMasterData] = useState([]); 

          // Input Forms State
          const [formData, setFormData] = useState({ period: 'Desember 2023', category: 'Retail', system: '', physical: '' });
          const [outboundForm, setOutboundForm] = useState({ category: 'Retail', product: 'D-1', month: 'Jan', qty: '' });
          const [utilizationForm, setUtilizationForm] = useState({ period: 'Jan', zone: 'Zona W/H Finish Good', capacity: '56549', used: '' });
          const [damageForm, setDamageForm] = useState({ month: 'Jan', handling: '', damage: '' });
          const [palletForm, setPalletForm] = useState({ month: 'Jan', returned25: '', returned26: '', outgoing25: '', outgoing26: '', targetQty: '1400', targetPct: '35' });

          // Bulk Upload State
          const [bulkText, setBulkText] = useState('');
          const [bulkPreview, setBulkPreview] = useState([]);
          const [bulkCategory, setBulkCategory] = useState('Retail'); 
          const [palletBulkText, setPalletBulkText] = useState('');
          const [palletBulkPreview, setPalletBulkPreview] = useState([]);
          const [masterBulkText, setMasterBulkText] = useState('');
          const [masterBulkPreview, setMasterBulkPreview] = useState([]);

          // Data Lists & Helpers
          const categories = ['Retail', 'Project', 'KN 1', 'KN 2', 'Pallet Silog', 'Pallet Project'];
          const outboundCategories = ['Retail', 'Project'];
          const warehouseZones = ['Zona W/H Finish Good']; 
          const outboundProductsList = [
            'ADV-1', 'ADV-2', 'D-1', 'D-2', 'D-2TR', 'D-2X', 'D-3', 'D-3SW', 'D-4', 
            'K-1', 'K-2', 'K-3', 'K-4', 'K-5', 'KN-1', 'KN-2', 'L-1', 'L-3', 'L-4', 
            'MiBond', 'Migrout', 'MIPlus', 'MIPro', 'MIProof Flex'
          ];
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

          // --- FIREBASE AUTHENTICATION & SYNC ---
          useEffect(() => {
            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Auth Error:", error);
              }
            };
            initAuth();

            const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
              setUser(currentUser);
              if (currentUser) setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          const syncCollection = (collName, setter) => {
            if (!user) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName));
            
            return onSnapshot(q, (snapshot) => {
              const fetchedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              if (collName === 'master_data_pallet') {
                fetchedData.sort((a, b) => (a.material || '').localeCompare(b.material || ''));
              } else {
                fetchedData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
              }
              setter(fetchedData);
            }, (error) => {
              console.error(`Error syncing ${collName}:`, error);
            });
          };

          useEffect(() => {
             if(!user) return;
             const unsub1 = syncCollection('stock_accuracy', setData);
             const unsub2 = syncCollection('outbound_fg', setOutboundData);
             const unsub3 = syncCollection('warehouse_utilization', setUtilizationData);
             const unsub4 = syncCollection('damage_rate', setDamageData);
             const unsub5 = syncCollection('pallet_return', setPalletReturnData); 
             const unsub6 = syncCollection('master_data_pallet', setMasterData); 
             return () => { 
               unsub1?.(); unsub2?.(); unsub3?.(); unsub4?.(); unsub5?.(); unsub6?.(); 
             };
          }, [user]);

          // --- COMPUTED METRICS ---
          const availablePeriods = useMemo(() => {
            const periods = [...new Set(data.map(item => item.period))];
            return ['Semua', ...periods];
          }, [data]);

          const dashboardData = useMemo(() => {
            if (filterPeriod === 'Semua') return data;
            return data.filter(item => item.period === filterPeriod);
          }, [data, filterPeriod]);

          const monthlyAccuracyTrend = useMemo(() => {
            const periodMap = {};
            data.forEach(item => {
              if (!periodMap[item.period]) {
                periodMap[item.period] = {
                  period: item.period,
                  totalSystem: 0,
                  totalAbsVariance: 0,
                  sortDate: item.date || new Date().toISOString() 
                };
              }
              periodMap[item.period].totalSystem += Number(item.system);
              periodMap[item.period].totalAbsVariance += Math.abs(item.variance);
              if (item.date && item.date < periodMap[item.period].sortDate) {
                periodMap[item.period].sortDate = item.date;
              }
            });

            const trends = Object.values(periodMap).map(p => {
              const acc = p.totalSystem === 0 ? 0 : ((1 - (p.totalAbsVariance / p.totalSystem)) * 100);
              return {
                name: p.period,
                accuracy: parseFloat(acc.toFixed(3)),
                sortDate: p.sortDate
              };
            });
            return trends.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
          }, [data]);

          const stats = useMemo(() => {
            if (dashboardData.length === 0) return { avgAccuracy: 0, totalVariance: 0, totalItems: 0, statusColor: 'text-slate-500' };
            const totalSystem = dashboardData.reduce((sum, item) => sum + Number(item.system), 0);
            const totalPhysical = dashboardData.reduce((sum, item) => sum + Number(item.physical), 0);
            const totalAbsVariance = dashboardData.reduce((sum, item) => sum + Math.abs(item.variance), 0);
            const globalAccuracy = totalSystem === 0 ? 0 : ((1 - (totalAbsVariance / totalSystem)) * 100);
            const isTargetMet = globalAccuracy >= TARGET_ACCURACY;
            return {
              avgAccuracy: globalAccuracy.toFixed(3),
              totalVariance: totalPhysical - totalSystem,
              totalItems: dashboardData.length,
              isTargetMet,
              statusColor: isTargetMet ? "text-emerald-600" : "text-rose-600"
            };
          }, [dashboardData, TARGET_ACCURACY]);

          const chartData = useMemo(() => {
            const agg = {};
            categories.forEach(c => { agg[c] = { category: c, totalSystem: 0, totalVariance: 0, count: 0 }; });
            dashboardData.forEach(item => {
              if (agg[item.category]) {
                agg[item.category].totalSystem += Number(item.system);
                agg[item.category].totalVariance += Math.abs(item.variance);
                agg[item.category].count += 1;
              }
            });
            return Object.values(agg).map(item => {
              const acc = item.totalSystem === 0 ? 0 : ((1 - (item.totalVariance / item.totalSystem)) * 100);
              return { name: item.category, accuracy: parseFloat(acc.toFixed(3)), count: item.count };
            });
          }, [dashboardData]);

          // --- Outbound Logic ---
          const outboundGlobals = useMemo(() => {
            let retailTotal = 0; let projectTotal = 0;
            outboundData.forEach(item => {
              const cat = item.category || 'Retail'; 
              if (cat === 'Retail') retailTotal += Number(item.qty);
              if (cat === 'Project') projectTotal += Number(item.qty);
            });
            const grandTotal = retailTotal + projectTotal;
            return { retailTotal, projectTotal, grandTotal,
              retailPercentage: grandTotal === 0 ? 0 : ((retailTotal / grandTotal) * 100).toFixed(1),
              projectPercentage: grandTotal === 0 ? 0 : ((projectTotal / grandTotal) * 100).toFixed(1)
            };
          }, [outboundData]);

          const globalOutboundMatrix = useMemo(() => {
            const matrix = {};
            outboundProductsList.forEach(p => { matrix[p] = { product: p, total: 0 }; months.forEach(m => matrix[p][m] = 0); });
            outboundData.forEach(item => {
                if (!matrix[item.product]) { 
                  matrix[item.product] = { product: item.product, total: 0 }; 
                  months.forEach(m => matrix[item.product][m] = 0); 
                }
                matrix[item.product][item.month] += Number(item.qty);
                matrix[item.product].total += Number(item.qty);
            });
            return Object.values(matrix).map(item => ({ ...item, percentage: outboundGlobals.grandTotal === 0 ? 0 : ((item.total / outboundGlobals.grandTotal) * 100).toFixed(1) }));
          }, [outboundData, outboundGlobals.grandTotal]);

          // --- Utilization Logic ---
          const utilizationStats = useMemo(() => {
            const latestSnapshot = utilizationData.sort((a, b) => b.timestamp - a.timestamp)[0] || { capacity: 56549, used: 0 };
            const totalCapacity = Number(latestSnapshot.capacity) || 56549;
            const totalUsed = Number(latestSnapshot.used) || 0;
            const utilizationRate = totalCapacity === 0 ? 0 : ((totalUsed / totalCapacity) * 100).toFixed(1);
            const monthlyTrendData = months.map(m => {
                const entry = utilizationData.filter(d => d.period && d.period.includes(m)).sort((a, b) => b.timestamp - a.timestamp)[0];
                const cap = entry ? Number(entry.capacity) : 56549; 
                const us = entry ? Number(entry.used) : 0;
                return { name: m, Used: us, Empty: cap > us ? cap - us : 0, Capacity: cap, utilization: cap === 0 ? 0 : (us / cap * 100).toFixed(1) };
            });
            return { totalCapacity, totalUsed, utilizationRate, emptySpace: totalCapacity - totalUsed, monthlyTrendData };
          }, [utilizationData]);

          // --- Damage Logic ---
          const damageStats = useMemo(() => {
            const totalHandling = damageData.reduce((sum, item) => sum + Number(item.handling), 0);
            const totalDamage = damageData.reduce((sum, item) => sum + Number(item.damage), 0);
            const avgRate = totalHandling === 0 ? 0 : ((totalDamage / totalHandling) * 100).toFixed(3);
            const monthlyTrend = months.map(m => {
                const entry = damageData.filter(d => d.month === m).sort((a, b) => b.timestamp - a.timestamp)[0];
                const h = entry ? Number(entry.handling) : 0;
                const d = entry ? Number(entry.damage) : 0;
                const r = h === 0 ? 0 : ((d / h) * 100).toFixed(3);
                return { name: m, rate: parseFloat(r), limit: DAMAGE_TOLERANCE };
            });
            return { totalHandling, totalDamage, avgRate, isSafe: parseFloat(avgRate) <= DAMAGE_TOLERANCE, monthlyTrend };
          }, [damageData]);

          // --- Pallet Logic ---
          const palletStats = useMemo(() => {
              const dataByMonth = {};
              months.forEach(m => dataByMonth[m] = { returned25: 0, returned26: 0, outgoing25: 0, outgoing26: 0, targetQty: 1400 });
              palletReturnData.forEach(item => {
                  if (dataByMonth[item.month]) {
                      dataByMonth[item.month].returned26 = Number(item.returned26 || item.returned || 0);
                      dataByMonth[item.month].returned25 = Number(item.returned25 || 0);
                      dataByMonth[item.month].outgoing26 = Number(item.outgoing26 || item.outgoing || 0);
                      dataByMonth[item.month].outgoing25 = Number(item.outgoing25 || 0);
                      if (item.targetQty) dataByMonth[item.month].targetQty = Number(item.targetQty);
                  }
              });
              const tableRows = months.map((m, idx) => {
                  const d = dataByMonth[m];
                  return { no: idx + 1, month: m, ...d };
              });
              const totalReturned26 = tableRows.reduce((sum, r) => sum + r.returned26, 0);
              const totalOutgoing26 = tableRows.reduce((sum, r) => sum + r.outgoing26, 0);
              const totalTargetQty = tableRows.reduce((sum, r) => sum + r.targetQty, 0); 
              const totalActualVsTarget = totalTargetQty === 0 ? 0 : Math.round((totalReturned26 / totalTargetQty) * 100);
              const totalActualVsOutgoing = totalOutgoing26 === 0 ? 0 : Math.round((totalReturned26 / totalOutgoing26) * 100);
              const chartData = tableRows.map(r => ({ name: r.month, Returned: r.returned26, Outgoing: r.outgoing26, Target: r.targetQty }));
              return { tableRows, totalReturned26, totalOutgoing26, totalTargetQty, totalActualVsTarget, totalActualVsOutgoing, chartData };
          }, [palletReturnData]);

          // --- EVENT HANDLERS ---
          const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
          const handleUtilizationChange = (e) => setUtilizationForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
          const handleOutboundChange = (e) => setOutboundForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
          const handleDamageChange = (e) => setDamageForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
          const handlePalletChange = (e) => setPalletForm(prev => ({ ...prev, [e.target.name]: e.target.value }));

          const handleAdminLogin = (e) => {
            e.preventDefault();
            if (loginUser === 'admin' && loginPass === 'admin123') {
              setIsAdminLoggedIn(true);
              setLoginError('');
              // Simpan sesi sementara di state (hilang saat refresh untuk keamanan)
            } else {
              setLoginError('Username atau Password salah!');
            }
          };

          const handleLogout = () => {
            setIsAdminLoggedIn(false);
            setLoginUser('');
            setLoginPass('');
          };

          const submitToFirebase = async (collectionName, dataObj, successMsg, resetFn) => {
            if (!user) return;
            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
                ...dataObj,
                timestamp: Date.now()
              });
              if (resetFn) resetFn();
              alert(successMsg || "Data tersimpan!"); 
            } catch (error) {
              console.error("Save Error:", error);
              alert("Gagal menyimpan data.");
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (formData.system === '' || formData.physical === '') return;
            const sys = Number(formData.system);
            const phys = Number(formData.physical);
            const variance = phys - sys;
            let acc = sys === 0 ? 0 : (1 - (Math.abs(variance) / sys)) * 100;
            if (acc < 0) acc = 0;
            submitToFirebase('stock_accuracy', {
              date: new Date().toISOString().split('T')[0],
              period: formData.period,
              category: formData.category,
              system: sys,
              physical: phys,
              variance: variance,
              accuracy: parseFloat(acc.toFixed(3))
            }, null, () => setFormData(prev => ({ ...prev, system: '', physical: '' })));
          };

          const handleOutboundSubmit = (e) => {
            e.preventDefault();
            if (outboundForm.qty === '') return;
            submitToFirebase('outbound_fg', {
              category: outboundForm.category,
              product: outboundForm.product,
              month: outboundForm.month,
              qty: Number(outboundForm.qty)
            }, "Data Outbound Tersimpan", () => setOutboundForm(prev => ({ ...prev, qty: '' })));
          };

          const handleUtilizationSubmit = (e) => {
            e.preventDefault();
            if (utilizationForm.capacity === '' || utilizationForm.used === '') return;
            submitToFirebase('warehouse_utilization', {
              period: utilizationForm.period,
              zone: utilizationForm.zone,
              capacity: Number(utilizationForm.capacity),
              used: Number(utilizationForm.used)
            }, "Data Utilisasi Tersimpan", () => setUtilizationForm(prev => ({ ...prev, capacity: '56549', used: '' })));
          };

          const handleDamageSubmit = (e) => {
            e.preventDefault();
            if (damageForm.handling === '' || damageForm.damage === '') return;
            submitToFirebase('damage_rate', {
              month: damageForm.month,
              handling: Number(damageForm.handling),
              damage: Number(damageForm.damage)
            }, "Data Damage Tersimpan", () => setDamageForm(prev => ({ ...prev, handling: '', damage: '' })));
          };

          const handlePalletSubmit = (e) => {
            e.preventDefault();
            submitToFirebase('pallet_return', {
              month: palletForm.month,
              returned25: Number(palletForm.returned25) || 0,
              returned26: Number(palletForm.returned26) || 0,
              outgoing25: Number(palletForm.outgoing25) || 0,
              outgoing26: Number(palletForm.outgoing26) || 0,
              targetQty: Number(palletForm.targetQty) || 1400
            }, "Data Pallet Tersimpan", () => setPalletForm(prev => ({ ...prev, returned25: '', returned26: '', outgoing25: '', outgoing26: '' })));
          };

          // --- BULK UPLOAD HANDLERS (Same as before) ---
          const saveBatchToFirebase = async (collectionName, dataArray, successMsg, resetFn) => {
            if (!user || dataArray.length === 0) return;
            setIsProcessing(true);
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
              const batchSize = 400;
              for (let i = 0; i < dataArray.length; i += batchSize) {
                const chunk = dataArray.slice(i, i + batchSize);
                const batch = writeBatch(db);
                chunk.forEach(item => {
                  const docRef = doc(collectionRef);
                  batch.set(docRef, { ...item, timestamp: Date.now() });
                });
                await batch.commit();
              }
              if (resetFn) resetFn();
              alert(successMsg);
            } catch (error) {
              console.error("Batch Save Error:", error);
              alert("Error saving batch data");
            } finally {
              setIsProcessing(false);
            }
          };

          const handleBulkParse = (text) => {
            setBulkText(text);
            if (!text) { setBulkPreview([]); return; }
            const lines = text.trim().split('\n');
            if (lines.length < 2) return;
            const preview = [];
            const headers = lines[0].split('\t').map(h => h.trim());
            const monthIndices = {};
            months.forEach(m => {
              const idx = headers.findIndex(h => h.toLowerCase().includes(m.toLowerCase()));
              if (idx !== -1) monthIndices[m] = idx;
            });
            let productColIdx = headers.findIndex(h => h.toLowerCase().includes('produk') || h.toLowerCase().includes('product'));
            if (productColIdx === -1) productColIdx = 1; 
            for (let i = 1; i < lines.length; i++) {
              const cols = lines[i].split('\t');
              if (cols.length <= productColIdx) continue;
              const product = cols[productColIdx]?.trim();
              if (!product) continue;
              Object.entries(monthIndices).forEach(([month, idx]) => {
                if (cols.length > idx) {
                  let valStr = cols[idx].trim();
                  if (valStr === '-' || valStr === '') return;
                  valStr = valStr.replace(/\./g, ''); 
                  const qty = Number(valStr);
                  if (!isNaN(qty) && qty > 0) {
                    preview.push({ category: bulkCategory, product, month, qty });
                  }
                }
              });
            }
            setBulkPreview(preview);
          };

          // --- RENDER DASHBOARD ---
          if (loading) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-slate-50">
                <Loader2 className="w-10 h-10 text-blue-600 animate-spin" />
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
              <nav className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 md:px-8 py-3 shadow-sm">
                <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                  <div className="flex items-center gap-2">
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-600 text-white p-2 rounded-lg shadow-md">
                      <Package size={20} />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold text-slate-900 leading-none tracking-tight">Supply Chain Dashboard</h1>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-slate-500 font-medium">Monitoring System</span>
                        <span className="flex items-center gap-1 text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full border border-green-200">
                          <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div> Online
                        </span>
                      </div>
                    </div>
                  </div>
                  <div className="flex bg-slate-100 p-1.5 rounded-xl border border-slate-200 overflow-x-auto max-w-full">
                    {['dashboard', 'outbound', 'utilization', 'damage', 'pallet', 'admin'].map(tab => (
                      <button key={tab} onClick={() => setActiveTab(tab)} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 whitespace-nowrap ${activeTab === tab ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>
                        {tab === 'dashboard' && <LayoutDashboard size={18} />}
                        {tab === 'outbound' && <Truck size={18} />}
                        {tab === 'utilization' && <Warehouse size={18} />}
                        {tab === 'damage' && <AlertTriangle size={18} />}
                        {tab === 'pallet' && <RotateCcw size={18} />}
                        {tab === 'admin' && <Settings size={18} />}
                        <span className="hidden md:inline">
                          {tab === 'dashboard' ? 'Stock Accuracy' : tab === 'outbound' ? 'Outbound FG' : tab === 'utilization' ? 'Utilisasi' : tab === 'damage' ? 'Damage Rate' : tab === 'pallet' ? 'Pallet Return' : 'Admin Input'}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>
              </nav>

              <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
                {activeTab === 'dashboard' && (
                  <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                      <div className="flex items-center gap-2 px-2">
                        <div className="bg-slate-100 p-2 rounded-lg"><Filter size={18} className="text-slate-500" /></div>
                        <div>
                          <span className="text-xs text-slate-400 block font-medium uppercase tracking-wider">Filter Periode</span>
                          <select value={filterPeriod} onChange={(e) => setFilterPeriod(e.target.value)} className="bg-transparent text-sm font-bold text-slate-800 outline-none cursor-pointer hover:text-blue-600 transition-colors">
                            {availablePeriods.map(p => (<option key={p} value={p}>{p}</option>))}
                          </select>
                        </div>
                      </div>
                      <button onClick={() => window.print()} className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><ClipboardList size={16} /> Cetak Laporan</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <StatCard title="Akurasi Global" value={`${stats.avgAccuracy}%`} subtext={stats.isTargetMet ? "Target Tercapai" : `Di Bawah Target ${TARGET_ACCURACY}%`} icon={CheckCircle} colorClass={stats.statusColor} />
                      <StatCard title="Target KPI" value={`${TARGET_ACCURACY}%`} subtext="Standar Minimum" icon={Target} colorClass="text-purple-600" />
                      <StatCard title="Net Variance" value={stats.totalVariance > 0 ? `+${stats.totalVariance}` : stats.totalVariance} subtext="Unit (Fisik - Sistem)" icon={AlertCircle} colorClass={stats.totalVariance === 0 ? "text-blue-600" : "text-rose-600"} />
                      <StatCard title="Total Transaksi" value={stats.totalItems} subtext={`Data Periode: ${filterPeriod}`} icon={Package} colorClass="text-indigo-600" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                      <div className="lg:col-span-3">
                        <Card className="border-t-4 border-t-blue-500">
                          <h3 className="text-lg font-bold text-slate-800 mb-4">Grafik Akurasi per Kategori</h3>
                          <div className="h-96 w-full p-2">
                            <ResponsiveContainer width="100%" height="100%">
                              <ComposedChart data={chartData} layout="vertical" margin={{ top: 10, right: 60, left: 20, bottom: 20 }}>
                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                                <XAxis type="number" domain={[99.8, 100.02]} tickFormatter={(value) => `${value}%`} tick={{fontSize: 12, fill: '#94a3b8', fontWeight: 500}} axisLine={false} tickLine={false} />
                                <YAxis dataKey="name" type="category" width={100} tick={{fill: '#334155', fontSize: 13, fontWeight: 700}} axisLine={false} tickLine={false} />
                                <Tooltip cursor={{fill: '#f8fafc', opacity: 0.6}} contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} formatter={(value) => [<span className="font-bold text-slate-700">{value}%</span>, 'Akurasi']} />
                                <ReferenceLine x={TARGET_ACCURACY} stroke="#8b5cf6" strokeDasharray="4 4" strokeWidth={2} label={{ value: `Target: ${TARGET_ACCURACY}%`, position: 'top', fill: '#8b5cf6', fontSize: 12, fontWeight: 'bold', offset: 10 }} />
                                <Bar dataKey="accuracy" name="Hasil STO Aktual" barSize={24} radius={[0, 6, 6, 0]}>
                                  {chartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.accuracy >= TARGET_ACCURACY ? '#10b981' : '#ef4444'} />))}
                                  <LabelList dataKey="accuracy" position="right" formatter={(val) => `${val}%`} style={{ fill: '#475569', fontSize: '12px', fontWeight: 'bold' }} offset={10} />
                                </Bar>
                              </ComposedChart>
                            </ResponsiveContainer>
                          </div>
                        </Card>
                      </div>
                    </div>
                    <div className="mt-8">
                      <Card className="border-t-4 border-t-indigo-500">
                        <h3 className="text-lg font-bold text-slate-800 mb-4">Tren Akurasi Bulanan (Global)</h3>
                        <div className="h-80 w-full p-2">
                          <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={monthlyAccuracyTrend} margin={{ top: 10, right: 30, left: 0, bottom: 5 }}>
                              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                              <XAxis dataKey="name" tick={{fontSize: 12}} />
                              <YAxis domain={['auto', 'auto']} tickFormatter={(val) => `${val}%`} />
                              <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} formatter={(value) => [`${value}%`, 'Akurasi']} />
                              <Legend />
                              <ReferenceLine y={TARGET_ACCURACY} stroke="#8b5cf6" strokeDasharray="5 5" label={{ value: `Target: ${TARGET_ACCURACY}%`, position: 'top', fill: '#8b5cf6', fontSize: 10 }} />
                              <Line type="monotone" dataKey="accuracy" stroke="#4f46e5" strokeWidth={3} dot={{r: 4, strokeWidth: 2}} activeDot={{r: 6}} name="Akurasi Global" />
                            </LineChart>
                          </ResponsiveContainer>
                        </div>
                      </Card>
                    </div>
                  </div>
                )}

                {activeTab === 'outbound' && (
                  <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center mb-2">
                      <div><h2 className="text-2xl font-bold text-slate-900">Outbound Finish Good</h2></div>
                      <button onClick={() => window.print()} className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium flex gap-2"><ClipboardList size={16} /> Export</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <StatCard title="Total Retail (YTD)" value={outboundGlobals.retailTotal.toLocaleString()} percentage={outboundGlobals.retailPercentage} icon={ShoppingBag} colorClass="text-blue-600" />
                      <StatCard title="Total Project (YTD)" value={outboundGlobals.projectTotal.toLocaleString()} percentage={outboundGlobals.projectPercentage} icon={Briefcase} colorClass="text-purple-600" />
                      <StatCard title="Total Outbound" value={outboundGlobals.grandTotal.toLocaleString()} icon={Layers} colorClass="text-emerald-600" />
                    </div>
                    <Card className="overflow-hidden border-t-4 border-t-emerald-500 shadow-md">
                      <div className="overflow-x-auto">
                        <table className="w-full text-xs md:text-sm text-left border-collapse">
                          <thead className="bg-slate-100 font-bold border-b-2">
                            <tr><th className="px-3 py-3 border-r w-32 sticky left-0 bg-slate-100">Produk</th>{months.map(m=><th key={m} className="px-2 text-center border-r">{m}</th>)}<th className="px-3 text-center bg-emerald-50 border-r">YTD</th><th className="px-3 text-center bg-emerald-50">%</th></tr>
                          </thead>
                          <tbody className="divide-y">
                            {globalOutboundMatrix.map((row,i)=>(<tr key={i} className={`hover:bg-slate-50 ${i%2===0?'bg-white':'bg-slate-50/30'}`}><td className="px-3 py-2 font-semibold border-r sticky left-0 bg-inherit">{row.product}</td>{months.map(m=><td key={m} className="px-2 text-center border-r">{row[m]===0?'-':row[m].toLocaleString()}</td>)}<td className="px-3 text-right font-bold bg-emerald-50/30 border-r">{row.total.toLocaleString()}</td><td className="px-3 text-center bg-emerald-50/30">{row.percentage}%</td></tr>))}
                          </tbody>
                        </table>
                      </div>
                    </Card>
                  </div>
                )}

                {activeTab === 'utilization' && (
                  <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                      <div><h2 className="text-2xl font-bold flex gap-2"><Warehouse className="text-blue-600"/> Warehouse Utilization</h2></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <StatCard title="Kapasitas" value={utilizationStats.totalCapacity.toLocaleString()} icon={Package} colorClass="text-slate-600"/>
                      <StatCard title="Terisi" value={utilizationStats.totalUsed.toLocaleString()} icon={Layers} colorClass="text-blue-600"/>
                      <StatCard title="Kosong" value={utilizationStats.emptySpace.toLocaleString()} icon={CheckCircle} colorClass="text-emerald-600"/>
                      <StatCard title="Utilisasi (%)" value={`${utilizationStats.utilizationRate}%`} icon={PieIcon} colorClass={utilizationStats.utilizationRate>85?"text-rose-600":"text-emerald-600"}/>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                      <div className="lg:col-span-2">
                        <Card><div className="h-80 w-full"><ResponsiveContainer width="100%" height="100%"><BarChart data={utilizationStats.monthlyTrendData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip/><Legend/><Bar dataKey="Used" stackId="a" fill="#3b82f6"/><Bar dataKey="Empty" stackId="a" fill="#e2e8f0"/></BarChart></ResponsiveContainer></div></Card>
                      </div>
                      <div className="lg:col-span-1"><Card className="h-full flex flex-col"><div className="flex-1 overflow-y-auto space-y-2">{utilizationStats.monthlyTrendData.map((d,i)=>(<div key={i} className="bg-slate-50 p-2 rounded border"><div className="flex justify-between font-bold text-sm"><span>{d.name}</span><span>{d.utilization}%</span></div><div className="w-full bg-slate-200 h-2 rounded"><div className={`h-2 rounded ${d.utilization>90?'bg-rose-500':'bg-blue-500'}`} style={{width:`${d.utilization}%`}}></div></div></div>))}</div></Card></div>
                    </div>
                  </div>
                )}

                {activeTab === 'damage' && (
                  <div className="space-y-8 animate-in fade-in duration-500">
                      <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                         <h2 className="text-2xl font-bold flex gap-2"><AlertTriangle className="text-red-600"/> Damage Rate</h2>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <StatCard title="Handling" value={damageStats.totalHandling.toLocaleString()} icon={Layers} colorClass="text-slate-600"/>
                         <StatCard title="Damage" value={damageStats.totalDamage.toLocaleString()} icon={AlertCircle} colorClass="text-red-600"/>
                         <StatCard title="Rate" value={`${damageStats.avgRate}%`} icon={Target} colorClass={damageStats.isSafe?"text-emerald-600":"text-red-600"}/>
                      </div>
                      <Card><div className="h-80 w-full"><ResponsiveContainer><ComposedChart data={damageStats.monthlyTrend}><CartesianGrid vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip/><Line type="monotone" dataKey="rate" stroke="#3b82f6" strokeWidth={3}/></ComposedChart></ResponsiveContainer></div></Card>
                  </div>
                )}

                {activeTab === 'pallet' && (
                  <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm"><h2 className="text-2xl font-bold flex gap-2"><RotateCcw className="text-amber-600"/> Pallet Return</h2></div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <StatCard title="Ret '26" value={palletStats.totalReturned26.toLocaleString()} icon={RotateCcw} colorClass="text-blue-600"/>
                        <StatCard title="Out '26" value={palletStats.totalOutgoing26.toLocaleString()} icon={Truck} colorClass="text-slate-600"/>
                        <StatCard title="Achv" value={`${palletStats.totalActualVsTarget}%`} icon={Target} colorClass="text-amber-600"/>
                        <StatCard title="Rate" value={`${palletStats.totalActualVsOutgoing}%`} icon={PieIcon} colorClass="text-purple-600"/>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2"><Card><div className="h-80 w-full"><ResponsiveContainer><ComposedChart data={palletStats.chartData}><CartesianGrid vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip/><Bar dataKey="Returned" fill="#3b82f6"/><Bar dataKey="Outgoing" fill="#94a3b8"/><Line type="monotone" dataKey="Target" stroke="#ef4444"/></ComposedChart></ResponsiveContainer></div></Card></div>
                        <div className="lg:col-span-3"><Card><div className="overflow-x-auto"><table className="w-full text-sm text-center border-collapse"><thead className="bg-slate-100 font-bold border-b-2"><tr><th rowSpan="2" className="p-2 border-r">Month</th><th colSpan="2" className="border-r">Return</th><th colSpan="2" className="border-r">Out</th></tr><tr><th>25</th><th>26</th><th>25</th><th>26</th></tr></thead><tbody>{palletStats.tableRows.map((r,i)=>(<tr key={i} className="hover:bg-slate-50"><td className="p-2 border-r">{r.month}</td><td className="border-r">{r.returned25}</td><td className="border-r font-bold text-blue-700">{r.returned26}</td><td className="border-r">{r.outgoing25}</td><td className="border-r">{r.outgoing26}</td></tr>))}</tbody></table></div></Card></div>
                    </div>
                  </div>
                )}

                {activeTab === 'admin' && (
                  <div className="min-h-[500px]">
                    {!isAdminLoggedIn ? (
                       <div className="flex flex-col items-center justify-center h-full pt-20 animate-in fade-in duration-500">
                          <Card className="w-full max-w-md p-8 border-t-4 border-t-blue-600">
                             <div className="flex flex-col items-center mb-6">
                                <div className="bg-blue-100 p-3 rounded-full mb-3">
                                   <Lock size={32} className="text-blue-600" />
                                </div>
                                <h2 className="text-2xl font-bold text-slate-800">Login Admin</h2>
                                <p className="text-slate-500 text-sm">Masuk untuk mengelola data</p>
                             </div>
                             <form onSubmit={handleAdminLogin} className="space-y-4">
                                <div>
                                   <label className="block text-xs font-bold text-slate-700 mb-1 uppercase">Username</label>
                                   <div className="relative">
                                     <User className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                     <input 
                                        type="text" 
                                        value={loginUser}
                                        onChange={(e) => setLoginUser(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                        placeholder="Masukkan username"
                                     />
                                   </div>
                                </div>
                                <div>
                                   <label className="block text-xs font-bold text-slate-700 mb-1 uppercase">Password</label>
                                   <div className="relative">
                                     <Lock className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                     <input 
                                        type="password" 
                                        value={loginPass}
                                        onChange={(e) => setLoginPass(e.target.value)}
                                        className="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                        placeholder="Masukkan password"
                                     />
                                   </div>
                                </div>
                                {loginError && (
                                   <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center gap-2">
                                      <AlertCircle size={16}/> {loginError}
                                   </div>
                                )}
                                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition-colors shadow-sm">
                                   Login Dashboard
                                </button>
                             </form>
                          </Card>
                       </div>
                    ) : (
                      <div className="space-y-6 animate-in fade-in duration-500">
                        <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                           <div className="flex items-center gap-3">
                              <div className="bg-green-100 p-2 rounded-full"><User size={20} className="text-green-700"/></div>
                              <div>
                                 <h2 className="text-lg font-bold text-slate-800">Admin Dashboard</h2>
                                 <p className="text-xs text-slate-500">Akses penuh pengelolaan data</p>
                              </div>
                           </div>
                           <button onClick={handleLogout} className="flex items-center gap-2 text-rose-600 hover:bg-rose-50 px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                              <LogOut size={16}/> Logout
                           </button>
                        </div>

                        <div className="flex justify-center">
                          <div className="bg-slate-200 p-1 rounded-lg inline-flex gap-1 flex-wrap justify-center">
                            {['stock','outbound','utilization','damage','pallet','bulk'].map(s=>(
                              <button key={s} onClick={()=>setAdminSection(s)} className={`px-4 py-2 text-sm font-bold rounded capitalize transition-all ${adminSection===s?'bg-white text-blue-700 shadow ring-1 ring-black/5':'text-slate-500 hover:text-slate-700'}`}>
                                {s}
                              </button>
                            ))}
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                          {adminSection === 'stock' && (
                             <div className="lg:col-span-1">
                                <Card className="border-t-4 border-t-blue-500">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Package size={20}/> Input Stock Accuracy</h2>
                                   <form onSubmit={handleSubmit} className="space-y-4">
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Periode</label>
                                         <input name="period" value={formData.period} onChange={handleInputChange} className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Desember 2023"/>
                                      </div>
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Kategori</label>
                                         <select name="category" value={formData.category} onChange={handleInputChange} className="w-full p-2 border rounded-lg outline-none">
                                            {categories.map(c=><option key={c} value={c}>{c}</option>)}
                                         </select>
                                      </div>
                                      <div className="grid grid-cols-2 gap-4">
                                         <div><label className="text-xs font-bold text-slate-500">System (Qty)</label><input name="system" type="number" value={formData.system} onChange={handleInputChange} className="w-full p-2 border rounded-lg outline-none" placeholder="0"/></div>
                                         <div><label className="text-xs font-bold text-slate-500">Fisik (Qty)</label><input name="physical" type="number" value={formData.physical} onChange={handleInputChange} className="w-full p-2 border rounded-lg outline-none" placeholder="0"/></div>
                                      </div>
                                      <button className="w-full bg-blue-600 text-white font-bold p-2.5 rounded-lg hover:bg-blue-700 transition-colors">Simpan Data</button>
                                   </form>
                                </Card>
                             </div>
                          )}

                          {adminSection === 'outbound' && (
                             <div className="lg:col-span-1">
                                <Card className="border-t-4 border-t-emerald-500">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Truck size={20}/> Input Outbound</h2>
                                   <form onSubmit={handleOutboundSubmit} className="space-y-4">
                                      <div className="grid grid-cols-2 gap-4">
                                         <div>
                                            <label className="text-xs font-bold text-slate-500">Kategori</label>
                                            <select name="category" value={outboundForm.category} onChange={handleOutboundChange} className="w-full p-2 border rounded-lg outline-none">
                                               {outboundCategories.map(c=><option key={c} value={c}>{c}</option>)}
                                            </select>
                                         </div>
                                         <div>
                                            <label className="text-xs font-bold text-slate-500">Bulan</label>
                                            <select name="month" value={outboundForm.month} onChange={handleOutboundChange} className="w-full p-2 border rounded-lg outline-none">
                                               {months.map(m=><option key={m} value={m}>{m}</option>)}
                                            </select>
                                         </div>
                                      </div>
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Produk</label>
                                         <select name="product" value={outboundForm.product} onChange={handleOutboundChange} className="w-full p-2 border rounded-lg outline-none">
                                            {outboundProductsList.map(p=><option key={p} value={p}>{p}</option>)}
                                         </select>
                                      </div>
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Qty Outbound</label>
                                         <input name="qty" type="number" value={outboundForm.qty} onChange={handleOutboundChange} className="w-full p-2 border rounded-lg outline-none" placeholder="0"/>
                                      </div>
                                      <button className="w-full bg-emerald-600 text-white font-bold p-2.5 rounded-lg hover:bg-emerald-700 transition-colors">Simpan Outbound</button>
                                   </form>
                                </Card>
                             </div>
                          )}

                          {adminSection === 'utilization' && (
                             <div className="lg:col-span-1">
                                <Card className="border-t-4 border-t-purple-500">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Warehouse size={20}/> Input Utilisasi</h2>
                                   <form onSubmit={handleUtilizationSubmit} className="space-y-4">
                                      <div className="grid grid-cols-2 gap-4">
                                         <div>
                                            <label className="text-xs font-bold text-slate-500">Periode</label>
                                            <select name="period" value={utilizationForm.period} onChange={handleUtilizationChange} className="w-full p-2 border rounded-lg outline-none">
                                               {months.map(m=><option key={m} value={m}>{m}</option>)}
                                            </select>
                                         </div>
                                         <div>
                                            <label className="text-xs font-bold text-slate-500">Zone</label>
                                            <select name="zone" value={utilizationForm.zone} onChange={handleUtilizationChange} className="w-full p-2 border rounded-lg outline-none">
                                               {warehouseZones.map(z=><option key={z} value={z}>{z}</option>)}
                                            </select>
                                         </div>
                                      </div>
                                      <div><label className="text-xs font-bold text-slate-500">Kapasitas Total</label><input name="capacity" type="number" value={utilizationForm.capacity} onChange={handleUtilizationChange} className="w-full p-2 border rounded-lg outline-none"/></div>
                                      <div><label className="text-xs font-bold text-slate-500">Terpakai (Used)</label><input name="used" type="number" value={utilizationForm.used} onChange={handleUtilizationChange} className="w-full p-2 border rounded-lg outline-none"/></div>
                                      <button className="w-full bg-purple-600 text-white font-bold p-2.5 rounded-lg hover:bg-purple-700 transition-colors">Simpan Utilisasi</button>
                                   </form>
                                </Card>
                             </div>
                          )}

                          {adminSection === 'damage' && (
                             <div className="lg:col-span-1">
                                <Card className="border-t-4 border-t-rose-500">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><AlertTriangle size={20}/> Input Damage</h2>
                                   <form onSubmit={handleDamageSubmit} className="space-y-4">
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Bulan</label>
                                         <select name="month" value={damageForm.month} onChange={handleDamageChange} className="w-full p-2 border rounded-lg outline-none">
                                            {months.map(m=><option key={m} value={m}>{m}</option>)}
                                         </select>
                                      </div>
                                      <div><label className="text-xs font-bold text-slate-500">Total Handling (Qty)</label><input name="handling" type="number" value={damageForm.handling} onChange={handleDamageChange} className="w-full p-2 border rounded-lg outline-none"/></div>
                                      <div><label className="text-xs font-bold text-slate-500">Total Damage (Qty)</label><input name="damage" type="number" value={damageForm.damage} onChange={handleDamageChange} className="w-full p-2 border rounded-lg outline-none"/></div>
                                      <button className="w-full bg-rose-600 text-white font-bold p-2.5 rounded-lg hover:bg-rose-700 transition-colors">Simpan Damage</button>
                                   </form>
                                </Card>
                             </div>
                          )}

                          {adminSection === 'pallet' && (
                             <div className="lg:col-span-1">
                                <Card className="border-t-4 border-t-amber-500">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><RotateCcw size={20}/> Input Pallet</h2>
                                   <form onSubmit={handlePalletSubmit} className="space-y-4">
                                      <div>
                                         <label className="text-xs font-bold text-slate-500">Bulan</label>
                                         <select name="month" value={palletForm.month} onChange={handlePalletChange} className="w-full p-2 border rounded-lg outline-none">
                                            {months.map(m=><option key={m} value={m}>{m}</option>)}
                                         </select>
                                      </div>
                                      <div className="grid grid-cols-2 gap-2 bg-slate-50 p-2 rounded">
                                         <p className="col-span-2 text-xs font-bold text-center border-b pb-1">Return</p>
                                         <div><label className="text-[10px] font-bold">Size 25</label><input name="returned25" type="number" value={palletForm.returned25} onChange={handlePalletChange} className="w-full p-1 border rounded text-sm"/></div>
                                         <div><label className="text-[10px] font-bold">Size 26</label><input name="returned26" type="number" value={palletForm.returned26} onChange={handlePalletChange} className="w-full p-1 border rounded text-sm"/></div>
                                      </div>
                                      <div className="grid grid-cols-2 gap-2 bg-slate-50 p-2 rounded">
                                         <p className="col-span-2 text-xs font-bold text-center border-b pb-1">Outgoing</p>
                                         <div><label className="text-[10px] font-bold">Size 25</label><input name="outgoing25" type="number" value={palletForm.outgoing25} onChange={handlePalletChange} className="w-full p-1 border rounded text-sm"/></div>
                                         <div><label className="text-[10px] font-bold">Size 26</label><input name="outgoing26" type="number" value={palletForm.outgoing26} onChange={handlePalletChange} className="w-full p-1 border rounded text-sm"/></div>
                                      </div>
                                      <button className="w-full bg-amber-600 text-white font-bold p-2.5 rounded-lg hover:bg-amber-700 transition-colors">Simpan Pallet</button>
                                   </form>
                                </Card>
                             </div>
                          )}

                          {adminSection === 'bulk' && (
                             <div className="lg:col-span-3">
                                <Card className="border-t-4 border-t-slate-600">
                                   <h2 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><FileSpreadsheet size={20}/> Bulk Upload (Copy-Paste Excel)</h2>
                                   <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                      <div>
                                         <div className="mb-4">
                                            <label className="text-xs font-bold text-slate-500 mb-2 block">Pilih Jenis Upload:</label>
                                            <div className="flex gap-2 mb-2">
                                               <button onClick={() => setBulkCategory('Retail')} className={`px-3 py-1 text-xs rounded border ${bulkCategory==='Retail'?'bg-blue-100 border-blue-300 font-bold':'bg-white'}`}>Outbound Retail</button>
                                               <button onClick={() => setBulkCategory('Project')} className={`px-3 py-1 text-xs rounded border ${bulkCategory==='Project'?'bg-blue-100 border-blue-300 font-bold':'bg-white'}`}>Outbound Project</button>
                                               <button onClick={() => setBulkCategory('Pallet')} className={`px-3 py-1 text-xs rounded border ${bulkCategory==='Pallet'?'bg-blue-100 border-blue-300 font-bold':'bg-white'}`}>Pallet Return</button>
                                            </div>
                                         </div>
                                         <textarea 
                                            value={bulkCategory === 'Pallet' ? palletBulkText : bulkText} 
                                            onChange={(e) => bulkCategory === 'Pallet' ? handlePalletBulkParse(e.target.value) : handleBulkParse(e.target.value)} 
                                            className="w-full h-48 p-2 text-xs font-mono border rounded-lg outline-none bg-slate-50" 
                                            placeholder="Paste data Excel di sini..."
                                         ></textarea>
                                         <button 
                                            onClick={() => bulkCategory === 'Pallet' ? saveBatchToFirebase('pallet_return', palletBulkPreview, 'Bulk Pallet Tersimpan!', () => {setPalletBulkPreview([]); setPalletBulkText('');}) : saveBatchToFirebase('outbound_fg', bulkPreview, 'Bulk Outbound Tersimpan!', () => {setBulkPreview([]); setBulkText('');})}
                                            disabled={isProcessing || (bulkCategory === 'Pallet' ? palletBulkPreview.length === 0 : bulkPreview.length === 0)}
                                            className="mt-4 w-full bg-slate-800 disabled:bg-slate-300 text-white font-bold p-2.5 rounded-lg hover:bg-slate-900 transition-colors flex items-center justify-center gap-2"
                                         >
                                            {isProcessing ? <Loader2 className="animate-spin"/> : <UploadCloud size={18}/>}
                                            Upload {bulkCategory === 'Pallet' ? palletBulkPreview.length : bulkPreview.length} Baris Data
                                         </button>
                                      </div>
                                      <div className="bg-slate-50 p-4 rounded-lg border max-h-80 overflow-y-auto">
                                         <h4 className="font-bold text-xs text-slate-500 uppercase mb-2">Preview Data</h4>
                                         {(bulkCategory === 'Pallet' ? palletBulkPreview : bulkPreview).length === 0 ? (
                                            <p className="text-slate-400 text-sm italic">Belum ada data valid...</p>
                                         ) : (
                                            <table className="w-full text-xs text-left">
                                               <thead>
                                                  <tr className="border-b">
                                                     {bulkCategory === 'Pallet' ? (
                                                        <><th>Bulan</th><th>Ret 26</th><th>Out 26</th></>
                                                     ) : (
                                                        <><th>Kategori</th><th>Produk</th><th>Bulan</th><th>Qty</th></>
                                                     )}
                                                  </tr>
                                               </thead>
                                               <tbody>
                                                  {(bulkCategory === 'Pallet' ? palletBulkPreview : bulkPreview).slice(0, 10).map((row, i) => (
                                                     <tr key={i} className="border-b last:border-0">
                                                        {bulkCategory === 'Pallet' ? (
                                                           <><td>{row.month}</td><td>{row.returned26}</td><td>{row.outgoing26}</td></>
                                                        ) : (
                                                           <><td>{row.category}</td><td>{row.product}</td><td>{row.month}</td><td>{row.qty}</td></>
                                                        )}
                                                     </tr>
                                                  ))}
                                               </tbody>
                                            </table>
                                         )}
                                         {(bulkCategory === 'Pallet' ? palletBulkPreview : bulkPreview).length > 10 && <p className="text-center text-xs text-slate-400 mt-2">...dan {(bulkCategory === 'Pallet' ? palletBulkPreview : bulkPreview).length - 10} baris lainnya</p>}
                                      </div>
                                   </div>
                                </Card>
                             </div>
                          )}

                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        }

        // --- RENDER KE DOM ---
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
