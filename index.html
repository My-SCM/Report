import React, { useState, useMemo, useEffect } from 'react';
import { 
  ComposedChart, BarChart, LineChart, Line, Bar, XAxis, YAxis, 
  CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine, 
  Legend, LabelList, PieChart, Pie 
} from 'recharts';
import { 
  ClipboardList, Save, Trash2, TrendingUp, AlertCircle, CheckCircle, 
  Package, Target, LayoutDashboard, Settings, Filter, Truck, Loader2, 
  FileSpreadsheet, UploadCloud, Briefcase, ShoppingBag, Layers, 
  ChevronDown, PieChart as PieIcon, Warehouse, Search, Table, 
  AlertTriangle, RotateCcw, Database 
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from "firebase/auth";
import { 
  getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, 
  query, writeBatch 
} from "firebase/firestore";

// --- KONFIGURASI FIREBASE ---
// Catatan: Untuk produksi, sebaiknya gunakan Environment Variables (process.env)
const userProvidedConfig = {
  apiKey: "AIzaSyDZF4CJLz9WFrbrv0EdSUqdpfyEPuPRAT4",
  authDomain: "laporan-eecfd.firebaseapp.com",
  projectId: "laporan-eecfd",
  storageBucket: "laporan-eecfd.firebasestorage.app",
  messagingSenderId: "789866197217",
  appId: "1:789866197217:web:b26378b445fa2c501fc7a0"
};

const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'stock-dashboard-default';

// --- UI COMPONENTS ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
    {children}
  </div>
);

const StatCard = ({ title, value, subtext, icon: Icon, colorClass, percentage }) => (
  <Card>
    <div className="flex items-start justify-between">
      <div>
        <p className="text-slate-500 text-sm font-medium mb-1">{title}</p>
        <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
        {percentage !== undefined && (
          <div className="flex items-center gap-2 mt-1.5 mb-1">
            <span className={`text-xs font-bold px-2 py-0.5 rounded-md bg-opacity-10 border ${colorClass.replace('text-', 'bg-')} ${colorClass.replace('text-', 'border-')} ${colorClass}`}>
              {percentage}%
            </span>
            <span className="text-[10px] text-slate-400 font-medium uppercase tracking-wide">Level</span>
          </div>
        )}
        {subtext && <p className={`text-xs ${percentage ? 'mt-0' : 'mt-1'} ${colorClass} opacity-80`}>{subtext}</p>}
      </div>
      <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10`}>
        <Icon size={24} className={colorClass.replace('text-', 'text-opacity-100 ')} />
      </div>
    </div>
  </Card>
);

// --- MAIN APPLICATION COMPONENT ---
export default function App() {
  // --- KONSTANTA SISTEM ---
  const TARGET_ACCURACY = 99.98;
  const DAMAGE_TOLERANCE = 0.50; 
  const TARGET_PALLET_QTY = 1400; 
  const TARGET_PALLET_PCT = 35; 

  // --- STATE MANAGEMENT ---
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [adminSection, setAdminSection] = useState('stock'); 
  const [filterPeriod, setFilterPeriod] = useState('Semua');
  const [outboundSubTab, setOutboundSubTab] = useState('Retail');
  const [searchTerm, setSearchTerm] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  
  // Data Collections
  const [data, setData] = useState([]);
  const [outboundData, setOutboundData] = useState([]);
  const [utilizationData, setUtilizationData] = useState([]);
  const [damageData, setDamageData] = useState([]);
  const [palletReturnData, setPalletReturnData] = useState([]); 
  const [masterData, setMasterData] = useState([]); 

  // Input Forms State
  const [formData, setFormData] = useState({ period: 'Desember 2023', category: 'Retail', system: '', physical: '' });
  const [outboundForm, setOutboundForm] = useState({ category: 'Retail', product: 'D-1', month: 'Jan', qty: '' });
  const [utilizationForm, setUtilizationForm] = useState({ period: 'Jan', zone: 'Zona W/H Finish Good', capacity: '56549', used: '' });
  const [damageForm, setDamageForm] = useState({ month: 'Jan', handling: '', damage: '' });
  const [palletForm, setPalletForm] = useState({ month: 'Jan', returned25: '', returned26: '', outgoing25: '', outgoing26: '', targetQty: '1400', targetPct: '35' });

  // Bulk Upload State
  const [bulkText, setBulkText] = useState('');
  const [bulkPreview, setBulkPreview] = useState([]);
  const [bulkCategory, setBulkCategory] = useState('Retail'); 
  const [palletBulkText, setPalletBulkText] = useState('');
  const [palletBulkPreview, setPalletBulkPreview] = useState([]);
  const [masterBulkText, setMasterBulkText] = useState('');
  const [masterBulkPreview, setMasterBulkPreview] = useState([]);

  // Data Lists & Helpers
  const categories = ['Retail', 'Project', 'KN 1', 'KN 2', 'Pallet Silog', 'Pallet Project'];
  const outboundCategories = ['Retail', 'Project'];
  const warehouseZones = ['Zona W/H Finish Good']; 
  const outboundProductsList = [
    'ADV-1', 'ADV-2', 'D-1', 'D-2', 'D-2TR', 'D-2X', 'D-3', 'D-3SW', 'D-4', 
    'K-1', 'K-2', 'K-3', 'K-4', 'K-5', 'KN-1', 'KN-2', 'L-1', 'L-3', 'L-4', 
    'MiBond', 'Migrout', 'MIPlus', 'MIPro', 'MIProof Flex'
  ];
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  // --- FIREBASE AUTHENTICATION & SYNC ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth Error:", error);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Helper untuk sinkronisasi realtime dengan Firestore
  const syncCollection = (collName, setter) => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName));
    
    return onSnapshot(q, (snapshot) => {
      const fetchedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Sorting logic
      if (collName === 'master_data_pallet') {
        fetchedData.sort((a, b) => (a.material || '').localeCompare(b.material || ''));
      } else {
        fetchedData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      }
      setter(fetchedData);
    }, (error) => {
      console.error(`Error syncing ${collName}:`, error);
    });
  };

  useEffect(() => {
     if(!user) return;
     
     const unsub1 = syncCollection('stock_accuracy', setData);
     const unsub2 = syncCollection('outbound_fg', setOutboundData);
     const unsub3 = syncCollection('warehouse_utilization', setUtilizationData);
     const unsub4 = syncCollection('damage_rate', setDamageData);
     const unsub5 = syncCollection('pallet_return', setPalletReturnData); 
     const unsub6 = syncCollection('master_data_pallet', setMasterData); 
     
     return () => { 
       unsub1?.(); unsub2?.(); unsub3?.(); unsub4?.(); unsub5?.(); unsub6?.(); 
     };
  }, [user]);

  // --- LOGIKA UTAMA (COMPUTED METRICS) ---

  // 1. Stock Accuracy Logic
  const availablePeriods = useMemo(() => {
    const periods = [...new Set(data.map(item => item.period))];
    return ['Semua', ...periods];
  }, [data]);

  const dashboardData = useMemo(() => {
    if (filterPeriod === 'Semua') return data;
    return data.filter(item => item.period === filterPeriod);
  }, [data, filterPeriod]);

  // Kalkulasi Tren Bulanan (Semua Data)
  const monthlyAccuracyTrend = useMemo(() => {
    const periodMap = {};
    
    // Grouping data by period
    data.forEach(item => {
      if (!periodMap[item.period]) {
        periodMap[item.period] = {
          period: item.period,
          totalSystem: 0,
          totalAbsVariance: 0,
          sortDate: item.date || new Date().toISOString() // Use date for sorting
        };
      }
      periodMap[item.period].totalSystem += Number(item.system);
      periodMap[item.period].totalAbsVariance += Math.abs(item.variance);
      // Keep earliest date for correct sorting
      if (item.date && item.date < periodMap[item.period].sortDate) {
        periodMap[item.period].sortDate = item.date;
      }
    });

    const trends = Object.values(periodMap).map(p => {
      const acc = p.totalSystem === 0 ? 0 : ((1 - (p.totalAbsVariance / p.totalSystem)) * 100);
      return {
        name: p.period,
        accuracy: parseFloat(acc.toFixed(3)),
        sortDate: p.sortDate
      };
    });

    // Sort chronologically
    return trends.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
  }, [data]);

  const stats = useMemo(() => {
    if (dashboardData.length === 0) return { avgAccuracy: 0, totalVariance: 0, totalItems: 0, statusColor: 'text-slate-500' };
    
    const totalSystem = dashboardData.reduce((sum, item) => sum + Number(item.system), 0);
    const totalPhysical = dashboardData.reduce((sum, item) => sum + Number(item.physical), 0);
    const totalAbsVariance = dashboardData.reduce((sum, item) => sum + Math.abs(item.variance), 0);
    
    const globalAccuracy = totalSystem === 0 ? 0 : ((1 - (totalAbsVariance / totalSystem)) * 100);
    const isTargetMet = globalAccuracy >= TARGET_ACCURACY;
    
    return {
      avgAccuracy: globalAccuracy.toFixed(3),
      totalVariance: totalPhysical - totalSystem,
      totalItems: dashboardData.length,
      isTargetMet,
      statusColor: isTargetMet ? "text-emerald-600" : "text-rose-600"
    };
  }, [dashboardData, TARGET_ACCURACY]);

  const chartData = useMemo(() => {
    const agg = {};
    categories.forEach(c => { agg[c] = { category: c, totalSystem: 0, totalVariance: 0, count: 0 }; });
    
    dashboardData.forEach(item => {
      if (agg[item.category]) {
        agg[item.category].totalSystem += Number(item.system);
        agg[item.category].totalVariance += Math.abs(item.variance);
        agg[item.category].count += 1;
      }
    });

    return Object.values(agg).map(item => {
      const acc = item.totalSystem === 0 ? 0 : ((1 - (item.totalVariance / item.totalSystem)) * 100);
      return { name: item.category, accuracy: parseFloat(acc.toFixed(3)), count: item.count };
    });
  }, [dashboardData]);

  // 2. Outbound Logic
  const outboundGlobals = useMemo(() => {
    let retailTotal = 0;
    let projectTotal = 0;
    
    outboundData.forEach(item => {
      const cat = item.category || 'Retail'; 
      if (cat === 'Retail') retailTotal += Number(item.qty);
      if (cat === 'Project') projectTotal += Number(item.qty);
    });
    
    const grandTotal = retailTotal + projectTotal;
    return { 
      retailTotal, projectTotal, grandTotal,
      retailPercentage: grandTotal === 0 ? 0 : ((retailTotal / grandTotal) * 100).toFixed(1),
      projectPercentage: grandTotal === 0 ? 0 : ((projectTotal / grandTotal) * 100).toFixed(1)
    };
  }, [outboundData]);

  const globalOutboundMatrix = useMemo(() => {
    const matrix = {};
    outboundProductsList.forEach(p => { 
      matrix[p] = { product: p, total: 0 }; 
      months.forEach(m => matrix[p][m] = 0); 
    });

    outboundData.forEach(item => {
        if (!matrix[item.product]) { 
          matrix[item.product] = { product: item.product, total: 0 }; 
          months.forEach(m => matrix[item.product][m] = 0); 
        }
        matrix[item.product][item.month] += Number(item.qty);
        matrix[item.product].total += Number(item.qty);
    });

    return Object.values(matrix).map(item => ({ 
      ...item, 
      percentage: outboundGlobals.grandTotal === 0 ? 0 : ((item.total / outboundGlobals.grandTotal) * 100).toFixed(1) 
    }));
  }, [outboundData, outboundGlobals.grandTotal]);

  // 3. Utilization Logic
  const utilizationStats = useMemo(() => {
    const latestSnapshot = utilizationData.sort((a, b) => b.timestamp - a.timestamp)[0] || { capacity: 56549, used: 0 };
    const totalCapacity = Number(latestSnapshot.capacity) || 56549;
    const totalUsed = Number(latestSnapshot.used) || 0;
    const utilizationRate = totalCapacity === 0 ? 0 : ((totalUsed / totalCapacity) * 100).toFixed(1);
    const emptySpace = totalCapacity - totalUsed;
    
    const monthlyTrendData = months.map(m => {
        const entry = utilizationData.filter(d => d.period && d.period.includes(m)).sort((a, b) => b.timestamp - a.timestamp)[0];
        const cap = entry ? Number(entry.capacity) : 56549; 
        const us = entry ? Number(entry.used) : 0;
        return { 
          name: m, 
          Used: us, 
          Empty: cap > us ? cap - us : 0, 
          Capacity: cap, 
          utilization: cap === 0 ? 0 : (us / cap * 100).toFixed(1) 
        };
    });
    return { totalCapacity, totalUsed, utilizationRate, emptySpace, monthlyTrendData };
  }, [utilizationData]);

  // 4. Damage Rate Logic
  const damageStats = useMemo(() => {
    const totalHandling = damageData.reduce((sum, item) => sum + Number(item.handling), 0);
    const totalDamage = damageData.reduce((sum, item) => sum + Number(item.damage), 0);
    const avgRate = totalHandling === 0 ? 0 : ((totalDamage / totalHandling) * 100).toFixed(3);
    const isSafe = parseFloat(avgRate) <= DAMAGE_TOLERANCE;
    
    const monthlyTrend = months.map(m => {
        const entry = damageData.filter(d => d.month === m).sort((a, b) => b.timestamp - a.timestamp)[0];
        const h = entry ? Number(entry.handling) : 0;
        const d = entry ? Number(entry.damage) : 0;
        const r = h === 0 ? 0 : ((d / h) * 100).toFixed(3);
        return { name: m, rate: parseFloat(r), limit: DAMAGE_TOLERANCE };
    });
    return { totalHandling, totalDamage, avgRate, isSafe, monthlyTrend };
  }, [damageData]);

  // 5. Pallet Return Logic
  const palletStats = useMemo(() => {
      const dataByMonth = {};
      months.forEach(m => dataByMonth[m] = { returned25: 0, returned26: 0, outgoing25: 0, outgoing26: 0, targetQty: 1400, targetPct: 35 });
      
      palletReturnData.forEach(item => {
          if (dataByMonth[item.month]) {
             dataByMonth[item.month].returned26 = Number(item.returned26 || item.returned || 0);
             dataByMonth[item.month].returned25 = Number(item.returned25 || 0);
             dataByMonth[item.month].outgoing26 = Number(item.outgoing26 || item.outgoing || 0);
             dataByMonth[item.month].outgoing25 = Number(item.outgoing25 || 0);
             if (item.targetQty) dataByMonth[item.month].targetQty = Number(item.targetQty);
          }
      });

      const tableRows = months.map((m, idx) => {
          const d = dataByMonth[m];
          const actualVsTarget = d.targetQty === 0 ? 0 : Math.round((d.returned26 / d.targetQty) * 100);
          const actualVsOutgoing = d.outgoing26 === 0 ? 0 : Math.round((d.returned26 / d.outgoing26) * 100);
          return { no: idx + 1, month: m, ...d, actualVsTarget, actualVsOutgoing };
      });

      const totalReturned26 = tableRows.reduce((sum, r) => sum + r.returned26, 0);
      const totalOutgoing26 = tableRows.reduce((sum, r) => sum + r.outgoing26, 0);
      const totalTargetQty = tableRows.reduce((sum, r) => sum + r.targetQty, 0); 
      const totalActualVsTarget = totalTargetQty === 0 ? 0 : Math.round((totalReturned26 / totalTargetQty) * 100);
      const totalActualVsOutgoing = totalOutgoing26 === 0 ? 0 : Math.round((totalReturned26 / totalOutgoing26) * 100);
      
      const chartData = tableRows.map(r => ({ name: r.month, Returned: r.returned26, Outgoing: r.outgoing26, Target: r.targetQty }));
      
      return { tableRows, totalReturned26, totalOutgoing26, totalTargetQty, totalActualVsTarget, totalActualVsOutgoing, chartData };
  }, [palletReturnData]);

  // 6. Master Data Search
  const filteredStandards = useMemo(() => {
    if (!searchTerm) return masterData;
    return masterData.filter(item => 
        (item.material || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
        (item.matNum || '').toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm, masterData]);

  // --- EVENT HANDLERS ---
  const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleUtilizationChange = (e) => setUtilizationForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleOutboundChange = (e) => setOutboundForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleDamageChange = (e) => setDamageForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handlePalletChange = (e) => setPalletForm(prev => ({ ...prev, [e.target.name]: e.target.value }));

  // Generic Submit Handler Wrapper
  const submitToFirebase = async (collectionName, dataObj, successMsg, resetFn) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
        ...dataObj,
        timestamp: Date.now()
      });
      if (resetFn) resetFn();
      // Menggunakan notifikasi kustom lebih baik daripada alert, tapi alert cukup untuk MVP
      alert(successMsg || "Data tersimpan!"); 
    } catch (error) {
      console.error("Save Error:", error);
      alert("Gagal menyimpan data.");
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (formData.system === '' || formData.physical === '' || formData.period === '') return;
    const sys = Number(formData.system);
    const phys = Number(formData.physical);
    const variance = phys - sys;
    let acc = sys === 0 ? 0 : (1 - (Math.abs(variance) / sys)) * 100;
    if (acc < 0) acc = 0;
    
    submitToFirebase('stock_accuracy', {
      date: new Date().toISOString().split('T')[0],
      period: formData.period,
      category: formData.category,
      system: sys,
      physical: phys,
      variance: variance,
      accuracy: parseFloat(acc.toFixed(3))
    }, null, () => setFormData(prev => ({ ...prev, system: '', physical: '' })));
  };

  const handleOutboundSubmit = (e) => {
    e.preventDefault();
    if (outboundForm.qty === '') return;
    submitToFirebase('outbound_fg', {
      category: outboundForm.category,
      product: outboundForm.product,
      month: outboundForm.month,
      qty: Number(outboundForm.qty)
    }, "Data Outbound Tersimpan", () => setOutboundForm(prev => ({ ...prev, qty: '' })));
  };

  const handleUtilizationSubmit = (e) => {
    e.preventDefault();
    if (utilizationForm.capacity === '' || utilizationForm.used === '') return;
    submitToFirebase('warehouse_utilization', {
      period: utilizationForm.period,
      zone: utilizationForm.zone,
      capacity: Number(utilizationForm.capacity),
      used: Number(utilizationForm.used)
    }, "Data Utilisasi Tersimpan", () => setUtilizationForm(prev => ({ ...prev, capacity: '56549', used: '' })));
  };

  const handleDamageSubmit = (e) => {
    e.preventDefault();
    if (damageForm.handling === '' || damageForm.damage === '') return;
    submitToFirebase('damage_rate', {
      month: damageForm.month,
      handling: Number(damageForm.handling),
      damage: Number(damageForm.damage)
    }, "Data Damage Tersimpan", () => setDamageForm(prev => ({ ...prev, handling: '', damage: '' })));
  };

  const handlePalletSubmit = (e) => {
    e.preventDefault();
    submitToFirebase('pallet_return', {
      month: palletForm.month,
      returned25: Number(palletForm.returned25) || 0,
      returned26: Number(palletForm.returned26) || 0,
      outgoing25: Number(palletForm.outgoing25) || 0,
      outgoing26: Number(palletForm.outgoing26) || 0,
      targetQty: Number(palletForm.targetQty) || 1400
    }, "Data Pallet Tersimpan", () => setPalletForm(prev => ({ ...prev, returned25: '', returned26: '', outgoing25: '', outgoing26: '' })));
  };

  // --- BULK UPLOAD HANDLERS ---
  
  // Generic Batch Save
  const saveBatchToFirebase = async (collectionName, dataArray, successMsg, resetFn) => {
    if (!user || dataArray.length === 0) return;
    setIsProcessing(true);
    try {
      const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
      const batchSize = 400;
      
      for (let i = 0; i < dataArray.length; i += batchSize) {
        const chunk = dataArray.slice(i, i + batchSize);
        const batch = writeBatch(db);
        chunk.forEach(item => {
          const docRef = doc(collectionRef);
          batch.set(docRef, { ...item, timestamp: Date.now() });
        });
        await batch.commit();
      }
      if (resetFn) resetFn();
      alert(successMsg);
    } catch (error) {
      console.error("Batch Save Error:", error);
      alert("Error saving batch data");
    } finally {
      setIsProcessing(false);
    }
  };

  // Outbound Bulk
  const handleBulkParse = (text) => {
    setBulkText(text);
    if (!text) { setBulkPreview([]); return; }
    
    const lines = text.trim().split('\n');
    if (lines.length < 2) return;
    
    const preview = [];
    const headers = lines[0].split('\t').map(h => h.trim());
    const monthIndices = {};
    
    months.forEach(m => {
      const idx = headers.findIndex(h => h.toLowerCase().includes(m.toLowerCase()));
      if (idx !== -1) monthIndices[m] = idx;
    });

    let productColIdx = headers.findIndex(h => h.toLowerCase().includes('produk') || h.toLowerCase().includes('product'));
    if (productColIdx === -1) productColIdx = 1; // Default fallback

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split('\t');
      if (cols.length <= productColIdx) continue;
      
      const product = cols[productColIdx]?.trim();
      if (!product) continue;

      Object.entries(monthIndices).forEach(([month, idx]) => {
        if (cols.length > idx) {
          let valStr = cols[idx].trim();
          if (valStr === '-' || valStr === '') return;
          valStr = valStr.replace(/\./g, ''); // Hapus pemisah ribuan
          const qty = Number(valStr);
          if (!isNaN(qty) && qty > 0) {
            preview.push({
              category: bulkCategory,
              product,
              month,
              qty
            });
          }
        }
      });
    }
    setBulkPreview(preview);
  };

  // Pallet Bulk
  const handlePalletBulkParse = (text) => {
    setPalletBulkText(text);
    if (!text) { setPalletBulkPreview([]); return; }
    
    const lines = text.trim().split('\n');
    const preview = [];
    
    lines.forEach(line => {
        const cols = line.split('\t').map(s => s.trim());
        if (cols.length < 2) return; 
        
        // Cari kolom bulan
        let mIdx = -1;
        for(let i=0; i<3; i++) {
           if (months.some(m => m.toLowerCase() === (cols[i] || '').toLowerCase())) {
             mIdx = i; break;
           }
        }

        if (mIdx !== -1) {
            const monthName = months.find(m => m.toLowerCase() === cols[mIdx].toLowerCase());
            const cleanNum = (str) => { if (!str) return 0; return Number(str.replace(/\./g, '')) || 0; };
            
            // Format Asumsi: No | Month | Ret25 | Ret26 | Out25 | Out26 
            const returned25 = cleanNum(cols[mIdx+1]);
            const returned26 = cleanNum(cols[mIdx+2]);
            const outgoing25 = cleanNum(cols[mIdx+3]);
            const outgoing26 = cleanNum(cols[mIdx+4]);
            
            if (returned26 > 0 || outgoing26 > 0 || returned25 > 0 || outgoing25 > 0) {
                 preview.push({ month: monthName, returned25, returned26, outgoing25, outgoing26 });
            }
        }
    });
    setPalletBulkPreview(preview);
  };

  // Master Data Bulk
  const handleMasterBulkParse = (text) => {
    setMasterBulkText(text);
    if (!text) { setMasterBulkPreview([]); return; }
    
    const lines = text.trim().split('\n');
    const preview = [];
    
    // Format Asumsi: Material | Base Unit | Material Number | Base Unit of Measure | Pallet to Zak | Pallet to Tonage
    lines.forEach(line => {
        const cols = line.split('\t').map(s => s.trim());
        if (cols.length >= 6) {
             const cleanNum = (str) => { if (!str) return 0; return Number(str.replace(/,/g, '.').trim()) || 0; };
             preview.push({
                 material: cols[0],
                 unit: cols[1],
                 matNum: cols[2],
                 pToZak: cleanNum(cols[4]),
                 pToTon: cleanNum(cols[5])
             });
        }
    });
    setMasterBulkPreview(preview);
  };

  const handleDelete = async (id, type) => {
    if (!user) return;
    if (!window.confirm("Apakah Anda yakin ingin menghapus data ini?")) return;

    let collName = 'stock_accuracy';
    if (type === 'outbound') collName = 'outbound_fg';
    if (type === 'utilization') collName = 'warehouse_utilization';
    if (type === 'damage') collName = 'damage_rate';
    if (type === 'pallet') collName = 'pallet_return';
    if (type === 'master') collName = 'master_data_pallet';
    
    try { 
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collName, id)); 
    } catch (error) { 
      console.error("Error deleting:", error); 
    }
  };

  // --- RENDER ---
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50">
        <Loader2 className="w-10 h-10 text-blue-600 animate-spin" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* NAVBAR */}
      <nav className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 md:px-8 py-3 shadow-sm">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center gap-2">
            <div className="bg-gradient-to-br from-blue-600 to-indigo-600 text-white p-2 rounded-lg shadow-md">
              <Package size={20} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-900 leading-none tracking-tight">Supply Chain Dashboard</h1>
              <div className="flex items-center gap-2">
                <span className="text-xs text-slate-500 font-medium">Monitoring System</span>
                <span className="flex items-center gap-1 text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full border border-green-200">
                  <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                  Online
                </span>
              </div>
            </div>
          </div>
          
          <div className="flex bg-slate-100 p-1.5 rounded-xl border border-slate-200 overflow-x-auto max-w-full">
            {['dashboard', 'outbound', 'utilization', 'damage', 'pallet', 'admin'].map(tab => (
              <button 
                key={tab} 
                onClick={() => setActiveTab(tab)}
                className={`
                  flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 whitespace-nowrap
                  ${activeTab === tab 
                    ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' 
                    : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}
                `}
              >
                {tab === 'dashboard' && <LayoutDashboard size={18} />}
                {tab === 'outbound' && <Truck size={18} />}
                {tab === 'utilization' && <Warehouse size={18} />}
                {tab === 'damage' && <AlertTriangle size={18} />}
                {tab === 'pallet' && <RotateCcw size={18} />}
                {tab === 'admin' && <Settings size={18} />}
                <span className="hidden md:inline">
                  {tab === 'dashboard' ? 'Stock Accuracy' : 
                   tab === 'outbound' ? 'Outbound FG' : 
                   tab === 'utilization' ? 'Utilisasi' : 
                   tab === 'damage' ? 'Damage Rate' : 
                   tab === 'pallet' ? 'Pallet Return' : 'Admin Input'}
                </span>
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* CONTENT AREA */}
      <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        
        {/* === TAB 1: STOCK ACCURACY === */}
        {activeTab === 'dashboard' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
              <div className="flex items-center gap-2 px-2">
                <div className="bg-slate-100 p-2 rounded-lg"><Filter size={18} className="text-slate-500" /></div>
                <div>
                  <span className="text-xs text-slate-400 block font-medium uppercase tracking-wider">Filter Periode</span>
                  <select 
                    value={filterPeriod} 
                    onChange={(e) => setFilterPeriod(e.target.value)} 
                    className="bg-transparent text-sm font-bold text-slate-800 outline-none cursor-pointer hover:text-blue-600 transition-colors"
                  >
                    {availablePeriods.map(p => (<option key={p} value={p}>{p}</option>))}
                  </select>
                </div>
              </div>
              <button 
                onClick={() => window.print()} 
                className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
              >
                <ClipboardList size={16} /> Cetak Laporan
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard title="Akurasi Global" value={`${stats.avgAccuracy}%`} subtext={stats.isTargetMet ? "Target Tercapai" : `Di Bawah Target ${TARGET_ACCURACY}%`} icon={CheckCircle} colorClass={stats.statusColor} />
              <StatCard title="Target KPI" value={`${TARGET_ACCURACY}%`} subtext="Standar Minimum" icon={Target} colorClass="text-purple-600" />
              <StatCard title="Net Variance" value={stats.totalVariance > 0 ? `+${stats.totalVariance}` : stats.totalVariance} subtext="Unit (Fisik - Sistem)" icon={AlertCircle} colorClass={stats.totalVariance === 0 ? "text-blue-600" : "text-rose-600"} />
              <StatCard title="Total Transaksi" value={stats.totalItems} subtext={`Data Periode: ${filterPeriod}`} icon={Package} colorClass="text-indigo-600" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-3">
                <Card className="border-t-4 border-t-blue-500">
                  <h3 className="text-lg font-bold text-slate-800 mb-4">Grafik Akurasi per Kategori</h3>
                  <div className="h-96 w-full p-2">
                    <ResponsiveContainer width="100%" height="100%">
                      <ComposedChart data={chartData} layout="vertical" margin={{ top: 10, right: 60, left: 20, bottom: 20 }}>
                        <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                        <XAxis type="number" domain={[99.8, 100.02]} tickFormatter={(value) => `${value}%`} tick={{fontSize: 12, fill: '#94a3b8', fontWeight: 500}} axisLine={false} tickLine={false} />
                        <YAxis dataKey="name" type="category" width={100} tick={{fill: '#334155', fontSize: 13, fontWeight: 700}} axisLine={false} tickLine={false} />
                        <Tooltip cursor={{fill: '#f8fafc', opacity: 0.6}} contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} formatter={(value) => [<span className="font-bold text-slate-700">{value}%</span>, 'Akurasi']} />
                        <ReferenceLine x={TARGET_ACCURACY} stroke="#8b5cf6" strokeDasharray="4 4" strokeWidth={2} label={{ value: `Target: ${TARGET_ACCURACY}%`, position: 'top', fill: '#8b5cf6', fontSize: 12, fontWeight: 'bold', offset: 10 }} />
                        <Bar dataKey="accuracy" name="Hasil STO Aktual" barSize={24} radius={[0, 6, 6, 0]}>
                          {chartData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.accuracy >= TARGET_ACCURACY ? '#10b981' : '#ef4444'} />
                          ))}
                          <LabelList dataKey="accuracy" position="right" formatter={(val) => `${val}%`} style={{ fill: '#475569', fontSize: '12px', fontWeight: 'bold' }} offset={10} />
                        </Bar>
                      </ComposedChart>
                    </ResponsiveContainer>
                  </div>
                </Card>
              </div>
            </div>

            {/* GRAFIK TREN AKURASI BULANAN (BARU) */}
            <div className="mt-8">
              <Card className="border-t-4 border-t-indigo-500">
                <h3 className="text-lg font-bold text-slate-800 mb-4">Tren Akurasi Bulanan (Global)</h3>
                <div className="h-80 w-full p-2">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={monthlyAccuracyTrend} margin={{ top: 10, right: 30, left: 0, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <XAxis dataKey="name" tick={{fontSize: 12}} />
                      <YAxis domain={['auto', 'auto']} tickFormatter={(val) => `${val}%`} />
                      <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} formatter={(value) => [`${value}%`, 'Akurasi']} />
                      <Legend />
                      <ReferenceLine y={TARGET_ACCURACY} stroke="#8b5cf6" strokeDasharray="5 5" label={{ value: `Target: ${TARGET_ACCURACY}%`, position: 'top', fill: '#8b5cf6', fontSize: 10 }} />
                      <Line type="monotone" dataKey="accuracy" stroke="#4f46e5" strokeWidth={3} dot={{r: 4, strokeWidth: 2}} activeDot={{r: 6}} name="Akurasi Global" />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </div>

          </div>
        )}

        {/* ... (TABS LAINNYA TETAP SAMA) ... */}
        {/* === TAB 2: OUTBOUND === */}
        {activeTab === 'outbound' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-center mb-2">
              <div>
                <h2 className="text-2xl font-bold text-slate-900">Outbound Finish Good</h2>
                <p className="text-slate-500">Rekapitulasi pengeluaran barang jadi bulanan</p>
              </div>
              <button onClick={() => window.print()} className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <ClipboardList size={16} /> Export Data
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard title="Total Retail (YTD)" value={outboundGlobals.retailTotal.toLocaleString()} percentage={outboundGlobals.retailPercentage} subtext="Total unit kategori Retail" icon={ShoppingBag} colorClass="text-blue-600" />
              <StatCard title="Total Project (YTD)" value={outboundGlobals.projectTotal.toLocaleString()} percentage={outboundGlobals.projectPercentage} subtext="Total unit kategori Project" icon={Briefcase} colorClass="text-purple-600" />
              <StatCard title="Total Outbound (All)" value={outboundGlobals.grandTotal.toLocaleString()} subtext="Total keseluruhan barang keluar" icon={Layers} colorClass="text-emerald-600" />
            </div>

            <Card className="overflow-hidden border-t-4 border-t-emerald-500 shadow-md">
              <div className="flex items-center gap-2 mb-4">
                <Layers className="text-emerald-600" size={20} />
                <h3 className="text-lg font-bold text-slate-800">Rekapitulasi Global (Retail + Project)</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-xs md:text-sm text-left border-collapse">
                  <thead className="bg-slate-100 text-slate-600 font-bold border-b-2 border-slate-200">
                    <tr>
                      <th className="px-3 py-3 border-r border-slate-200 sticky left-0 bg-slate-100 z-10 w-32">Produk</th>
                      {months.map(m => (<th key={m} className="px-2 py-3 text-center border-r border-slate-200 w-16">{m}</th>))}
                      <th className="px-3 py-3 text-center bg-emerald-50 text-emerald-700 border-r border-slate-200 font-extrabold w-20">YTD</th>
                      <th className="px-3 py-3 text-center bg-emerald-50 text-emerald-700 font-extrabold w-16">%</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {globalOutboundMatrix.map((row, idx) => (
                      <tr key={idx} className={`hover:bg-slate-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}`}>
                        <td className="px-3 py-2 font-semibold text-slate-700 border-r border-slate-200 sticky left-0 bg-inherit z-10">{row.product}</td>
                        {months.map(m => (<td key={m} className="px-2 py-2 text-center text-slate-500 border-r border-slate-100 font-mono">{row[m] === 0 ? '-' : row[m].toLocaleString()}</td>))}
                        <td className="px-3 py-2 text-right font-bold text-emerald-700 bg-emerald-50/30 border-r border-slate-200 font-mono">{row.total.toLocaleString()}</td>
                        <td className="px-3 py-2 text-center text-xs font-bold text-slate-600 bg-emerald-50/30 relative">
                          <div className="absolute left-0 top-0 bottom-0 bg-emerald-200 opacity-30 transition-all" style={{ width: `${Math.min(row.percentage, 100)}%` }}></div>
                          <span className="relative z-10">{row.percentage}%</span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Card>
          </div>
        )}

        {/* === TAB 3: WAREHOUSE UTILIZATION === */}
        {activeTab === 'utilization' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
              <div>
                <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                  <Warehouse className="text-blue-600" /> Warehouse Utilization
                </h2>
                <p className="text-slate-500 text-sm">Monitoring kapasitas dan keterisian gudang</p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard title="Total Kapasitas" value={utilizationStats.totalCapacity.toLocaleString()} subtext="Kapasitas Zak (Default)" icon={Package} colorClass="text-slate-600" />
              <StatCard title="Terisi (Occupied)" value={utilizationStats.totalUsed.toLocaleString()} subtext="Unit tersimpan saat ini" icon={Layers} colorClass="text-blue-600" />
              <StatCard title="Sisa Ruang (Empty)" value={utilizationStats.emptySpace.toLocaleString()} subtext="Kapasitas tersedia" icon={CheckCircle} colorClass="text-emerald-600" />
              <StatCard title="Utilisasi (%)" value={`${utilizationStats.utilizationRate}%`} subtext={utilizationStats.utilizationRate > 85 ? "Kritis (>85%)" : "Normal"} icon={PieIcon} colorClass={utilizationStats.utilizationRate > 85 ? "text-rose-600" : "text-emerald-600"} />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2">
                <Card>
                  <h3 className="text-lg font-bold text-slate-800 mb-6">Tren Utilisasi Bulanan</h3>
                  <div className="h-80 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={utilizationStats.monthlyTrendData} margin={{top: 20, right: 30, left: 20, bottom: 5}}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                        <YAxis />
                        <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                        <Legend />
                        <Bar dataKey="Used" stackId="a" fill="#3b82f6" name="Terisi" radius={[0, 0, 4, 4]} />
                        <Bar dataKey="Empty" stackId="a" fill="#e2e8f0" name="Kosong" radius={[4, 4, 0, 0]} />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </Card>
              </div>
              <div className="lg:col-span-1">
                <Card className="h-full flex flex-col">
                  <h3 className="text-lg font-bold text-slate-800 mb-4">Detail Bulanan (%)</h3>
                  <div className="flex-1 overflow-y-auto pr-2 space-y-4">
                    {utilizationStats.monthlyTrendData.map((data, idx) => (
                      <div key={idx} className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div className="flex justify-between items-center mb-1">
                          <span className="font-bold text-sm text-slate-700">{data.name}</span>
                          <span className={`text-sm font-bold ${Number(data.utilization) > 90 ? 'text-rose-600' : 'text-slate-600'}`}> {data.utilization}% </span>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2">
                          <div className={`h-2 rounded-full transition-all duration-500 ${Number(data.utilization) > 90 ? 'bg-rose-500' : Number(data.utilization) > 75 ? 'bg-amber-500' : 'bg-blue-500'}`} style={{ width: `${Math.min(data.utilization, 100)}%` }}></div>
                        </div>
                      </div>
                    ))}
                  </div>
                </Card>
              </div>
            </div>

            <div className="mt-8">
              <Card className="border-t-4 border-t-slate-600">
                <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                  <div>
                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                      <Table size={20} className="text-slate-500"/> Master Data: Standar Palletisasi
                    </h3>
                  </div>
                  <div className="relative">
                    <Search className="absolute left-3 top-2.5 text-slate-400" size={16} />
                    <input type="text" placeholder="Cari Material / Nomor..." className="pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none w-64" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                  </div>
                </div>
                <div className="overflow-x-auto max-h-[400px] overflow-y-auto rounded-lg border border-slate-100">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 sticky top-0 z-10">
                      <tr>
                        <th className="px-4 py-3">Material</th>
                        <th className="px-4 py-3">Base Unit</th>
                        <th className="px-4 py-3">Material Number</th>
                        <th className="px-4 py-3 text-right">Pallet to Zak</th>
                        <th className="px-4 py-3 text-right">Pallet to Tonage</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {filteredStandards.map((item, idx) => (
                        <tr key={idx} className="hover:bg-slate-50">
                          <td className="px-4 py-2 font-mono text-slate-700">{item.material}</td>
                          <td className="px-4 py-2 text-slate-500">{item.unit}</td>
                          <td className="px-4 py-2 text-slate-600">{item.matNum}</td>
                          <td className="px-4 py-2 text-right font-bold text-blue-600">{item.pToZak}</td>
                          <td className="px-4 py-2 text-right font-mono">{item.pToTon}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </Card>
            </div>
          </div>
        )}

        {/* === TAB 4: DAMAGE RATE === */}
        {activeTab === 'damage' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
              <div>
                <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                  <AlertTriangle className="text-red-600" /> Damage Rate Produk
                </h2>
                <p className="text-slate-500 text-sm">Monitoring kerusakan produk akibat handling di W/H FG</p>
              </div>
              <span className="bg-red-50 text-red-700 border border-red-200 px-3 py-1 rounded-full text-xs font-bold"> Max Toleransi: {DAMAGE_TOLERANCE}% </span>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <StatCard title="Total Handling (YTD)" value={damageStats.totalHandling.toLocaleString()} subtext="Total unit yang diproses" icon={Layers} colorClass="text-slate-600" />
              <StatCard title="Total Damage (YTD)" value={damageStats.totalDamage.toLocaleString()} subtext="Total unit rusak" icon={AlertCircle} colorClass="text-red-600" />
              <StatCard title="Rata-rata Damage Rate" value={`${damageStats.avgRate}%`} subtext={damageStats.isSafe ? "Dalam Toleransi (Aman)" : "Melebihi Toleransi!"} icon={Target} colorClass={damageStats.isSafe ? "text-emerald-600" : "text-red-600"} />
            </div>

            <Card>
              <h3 className="text-lg font-bold text-slate-800 mb-6">Tren Damage Rate Bulanan (%)</h3>
              <div className="h-80 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <ComposedChart data={damageStats.monthlyTrend} margin={{top: 20, right: 30, left: 0, bottom: 5}}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                    <XAxis dataKey="name" tick={{fontSize: 12}} />
                    <YAxis domain={[0, 'auto']} tickFormatter={(val) => `${val}%`} />
                    <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} formatter={(value) => [`${value}%`, 'Damage Rate']} />
                    <Legend />
                    <ReferenceLine y={DAMAGE_TOLERANCE} stroke="#ef4444" strokeDasharray="5 5" label={{ value: `Max: ${DAMAGE_TOLERANCE}%`, position: 'top', fill: '#ef4444', fontSize: 10, fontWeight: 'bold' }} />
                    <Line type="monotone" dataKey="rate" stroke="#3b82f6" strokeWidth={3} dot={{r: 4, strokeWidth: 2}} activeDot={{r: 6}} name="Damage Rate" />
                  </ComposedChart>
                </ResponsiveContainer>
              </div>
            </Card>
          </div>
        )}

        {/* === TAB 5: PALLET RETURN === */}
        {activeTab === 'pallet' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
              <div>
                <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                  <RotateCcw className="text-amber-600" /> Pallet Return Monitoring
                </h2>
                <p className="text-slate-500 text-sm">Monitoring pengembalian pallet vs pengiriman</p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <StatCard title="Total Pallet Kembali 2026 (YTD)" value={palletStats.totalReturned26.toLocaleString()} subtext="Unit Pallet Masuk" icon={RotateCcw} colorClass="text-blue-600" />
              <StatCard title="Total Pallet Keluar 2026 (YTD)" value={palletStats.totalOutgoing26.toLocaleString()} subtext="Unit Pallet Dikirim" icon={Truck} colorClass="text-slate-600" />
              <StatCard title="Target Achievement (YTD)" value={`${palletStats.totalActualVsTarget}%`} subtext={`Target: ${TARGET_PALLET_QTY}`} icon={Target} colorClass={palletStats.totalActualVsTarget >= 100 ? "text-emerald-600" : "text-amber-600"} />
              <StatCard title="Return Rate (YTD)" value={`${palletStats.totalActualVsOutgoing}%`} subtext="Actual Kembali vs Keluar" icon={PieIcon} colorClass="text-purple-600" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2">
                <Card>
                  <h3 className="text-lg font-bold text-slate-800 mb-6">Tren Pallet: Kembali vs Keluar (2026)</h3>
                  <div className="h-80 w-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <ComposedChart data={palletStats.chartData} margin={{top: 20, right: 30, left: 20, bottom: 5}}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                        <XAxis dataKey="name" tick={{fontSize: 12}} />
                        <YAxis />
                        <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                        <Legend />
                        <Bar dataKey="Returned" fill="#3b82f6" name="Pallet Kembali 26" barSize={20} radius={[4, 4, 0, 0]} />
                        <Bar dataKey="Outgoing" fill="#94a3b8" name="Pallet Keluar 26" barSize={20} radius={[4, 4, 0, 0]} />
                        <Line type="monotone" dataKey="Target" stroke="#ef4444" strokeWidth={2} strokeDasharray="5 5" dot={false} name="Target Qty" />
                      </ComposedChart>
                    </ResponsiveContainer>
                  </div>
                </Card>
              </div>

              <div className="lg:col-span-3">
                <Card className="overflow-hidden border border-slate-200">
                  <h3 className="text-lg font-bold text-slate-800 mb-4 px-2">Detail Data Bulanan</h3>
                  <div className="overflow-x-auto rounded-lg border border-slate-100">
                    <table className="w-full text-xs md:text-sm text-center border-collapse">
                      <thead className="bg-slate-100 text-slate-700 font-bold border-b-2 border-slate-200">
                        <tr>
                          <th rowSpan="2" className="p-3 border-r border-slate-200">No</th>
                          <th rowSpan="2" className="p-3 border-r border-slate-200 text-left">Month</th>
                          <th colSpan="2" className="p-2 border-r border-slate-200 bg-gray-50">Pallet Kembali (Pcs)</th>
                          <th colSpan="2" className="p-2 border-r border-slate-200 bg-gray-50">Pallet Keluar (Pcs)</th>
                          <th rowSpan="2" className="p-2 border-r border-slate-200 w-32">Achv Target (%)</th>
                          <th rowSpan="2" className="p-2 w-32">Return Rate (%)</th>
                        </tr>
                        <tr className="border-t border-slate-200">
                          <th className="p-2 border-r border-slate-200 bg-gray-50/50">2025</th>
                          <th className="p-2 border-r border-slate-200 bg-gray-50/50">2026</th>
                          <th className="p-2 border-r border-slate-200 bg-gray-50/50">2025</th>
                          <th className="p-2 border-r border-slate-200 bg-gray-50/50">2026</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100 text-slate-600">
                        {palletStats.tableRows.map((row, idx) => (
                          <tr key={idx} className="hover:bg-slate-50">
                            <td className="p-2 border-r border-slate-100">{row.no}</td>
                            <td className="p-2 border-r border-slate-100 text-left font-medium">{row.month}</td>
                            <td className="p-2 border-r border-slate-100 font-mono text-slate-400">{row.returned25 ? row.returned25.toLocaleString() : '-'}</td>
                            <td className="p-2 border-r border-slate-100 font-mono text-blue-700 font-bold">{row.returned26.toLocaleString()}</td>
                            <td className="p-2 border-r border-slate-100 font-mono text-slate-400">{row.outgoing25 ? row.outgoing25.toLocaleString() : '-'}</td>
                            <td className="p-2 border-r border-slate-100 font-mono text-slate-700">{row.outgoing26.toLocaleString()}</td>
                            <td className={`p-2 border-r border-slate-100 font-bold ${row.actualVsTarget >= 100 ? 'text-emerald-600' : 'text-rose-600'}`}>{row.actualVsTarget}%</td>
                            <td className="p-2 font-bold">{row.actualVsOutgoing}%</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </Card>
              </div>
            </div>
          </div>
        )}

        {/* === TAB 6: ADMIN INPUT === */}
        {activeTab === 'admin' && (
          <div className="animate-in slide-in-from-right duration-500 space-y-6">
            {/* Admin Navigation */}
            <div className="flex justify-center">
              <div className="bg-slate-200 p-1 rounded-lg inline-flex flex-wrap gap-1 justify-center">
                {['stock', 'outbound', 'utilization', 'damage', 'pallet', 'master'].map(sec => (
                  <button 
                    key={sec} 
                    onClick={() => setAdminSection(sec)} 
                    className={`
                      px-4 py-2 text-sm font-bold rounded-md transition-all capitalize
                      ${adminSection === sec ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}
                    `}
                  >
                    {sec} Input
                  </button>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* STOCK ADMIN */}
              {adminSection === 'stock' && (
                <>
                  <div className="lg:col-span-1 space-y-6">
                    <Card className="bg-white border-blue-100 shadow-md">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="bg-blue-600 p-2.5 rounded-xl text-white shadow-lg"><Save size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Input Data Stok</h2>
                      </div>
                      <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Periode</label>
                          <input type="text" name="period" value={formData.period} onChange={handleInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Kategori</label>
                          <select name="category" value={formData.category} onChange={handleInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                            {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                          </select>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Sistem</label>
                            <input type="number" name="system" value={formData.system} onChange={handleInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Fisik</label>
                            <input type="number" name="physical" value={formData.physical} onChange={handleInputChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required />
                          </div>
                        </div>
                        <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">Simpan</button>
                      </form>
                    </Card>
                  </div>
                  <div className="lg:col-span-2">
                    <Card className="h-full">
                      <h3 className="text-lg font-bold text-slate-800 mb-4">Database: Stock Accuracy</h3>
                      <div className="overflow-x-auto max-h-[600px] rounded-lg border border-slate-100">
                         <table className="w-full text-sm text-left">
                           <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 sticky top-0">
                             <tr><th className="px-4 py-3">Periode</th><th className="px-4 py-3">Kategori</th><th className="px-4 py-3 text-right">Akurasi</th><th className="px-4 py-3 text-center">Aksi</th></tr>
                           </thead>
                           <tbody className="divide-y divide-slate-100">
                             {data.map(item => (
                               <tr key={item.id} className="hover:bg-slate-50">
                                 <td className="px-4 py-3">{item.period}</td>
                                 <td className="px-4 py-3"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold border border-slate-200">{item.category}</span></td>
                                 <td className="px-4 py-3 text-right font-bold">{item.accuracy}%</td>
                                 <td className="px-4 py-3 text-center"><button onClick={() => handleDelete(item.id, 'stock')} className="text-slate-400 hover:text-red-600"><Trash2 size={16}/></button></td>
                               </tr>
                             ))}
                           </tbody>
                         </table>
                      </div>
                    </Card>
                  </div>
                </>
              )}
              
              {/* OUTBOUND ADMIN */}
              {adminSection === 'outbound' && (
                <>
                 <div className="lg:col-span-1 space-y-6">
                   <Card className="bg-white border-green-100 shadow-md">
                     <div className="flex items-center gap-3 mb-6">
                        <div className="bg-green-600 p-2.5 rounded-xl text-white shadow-lg"><FileSpreadsheet size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Bulk Upload (Excel)</h2>
                     </div>
                     <div className="space-y-4">
                       <label className="block text-sm font-semibold text-slate-700">Paste Data Excel:</label>
                       <textarea value={bulkText} onChange={(e) => handleBulkParse(e.target.value)} placeholder="Format: No | Produk | Jan | Feb..." className="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono outline-none focus:ring-2 focus:ring-green-500" />
                       <div className="flex bg-slate-100 p-1 rounded-lg">
                          {outboundCategories.map(cat => (
                            <button key={cat} onClick={() => setBulkCategory(cat)} className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${bulkCategory === cat ? 'bg-white text-green-700 shadow-sm' : 'text-slate-400'}`}>{cat}</button>
                          ))}
                       </div>
                       <button onClick={() => saveBatchToFirebase('outbound_fg', bulkPreview, "Bulk Outbound Saved!", () => { setBulkText(''); setBulkPreview([]); })} disabled={bulkPreview.length === 0 || isProcessing} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg flex justify-center items-center gap-2 ${bulkPreview.length > 0 ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-300'}`}>
                          {isProcessing ? <Loader2 className="animate-spin" /> : <UploadCloud />} Simpan {bulkPreview.length} Data
                       </button>
                     </div>
                   </Card>
                 </div>
                 <div className="lg:col-span-2">
                   <Card className="h-full">
                      <h3 className="text-lg font-bold text-slate-800 mb-4">Preview & History</h3>
                      {bulkPreview.length > 0 && (
                        <div className="mb-6 overflow-x-auto rounded-lg border border-green-200 bg-green-50/30 max-h-[300px]">
                           <table className="w-full text-xs text-left">
                             <thead className="bg-green-100 text-green-800 font-semibold sticky top-0"><tr><th className="px-3 py-2">Produk</th><th className="px-3 py-2">Bulan</th><th className="px-3 py-2 text-right">Qty</th></tr></thead>
                             <tbody>{bulkPreview.map((item, i) => (<tr key={i} className="border-b border-green-100"><td className="px-3 py-1">{item.product}</td><td className="px-3 py-1">{item.month}</td><td className="px-3 py-1 text-right">{item.qty}</td></tr>))}</tbody>
                           </table>
                        </div>
                      )}
                      <div className="overflow-x-auto max-h-[400px]">
                         <table className="w-full text-xs text-left">
                           <thead className="bg-slate-50 text-slate-500 sticky top-0"><tr><th>Kategori</th><th>Produk</th><th>Bulan</th><th>Qty</th><th>Aksi</th></tr></thead>
                           <tbody>{outboundData.map(item => (<tr key={item.id} className="hover:bg-slate-50"><td>{item.category}</td><td>{item.product}</td><td>{item.month}</td><td>{item.qty}</td><td><button onClick={() => handleDelete(item.id, 'outbound')} className="text-red-400"><Trash2 size={12}/></button></td></tr>))}</tbody>
                         </table>
                      </div>
                   </Card>
                 </div>
                </>
              )}

              {/* UTILIZATION ADMIN - DIKEMBALIKAN */}
              {adminSection === 'utilization' && (
                <>
                  <div className="lg:col-span-1 space-y-6">
                    <Card className="bg-white border-emerald-100 shadow-md">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="bg-emerald-600 p-2.5 rounded-xl text-white shadow-lg"><Warehouse size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Input Utilisasi</h2>
                      </div>
                      <form onSubmit={handleUtilizationSubmit} className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Bulan Data</label>
                          <select name="period" value={utilizationForm.period} onChange={handleUtilizationChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                            {months.map(m => <option key={m} value={m}>{m}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Pilih Zona</label>
                          <select name="zone" value={utilizationForm.zone} onChange={handleUtilizationChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                            {warehouseZones.map(z => <option key={z} value={z}>{z}</option>)}
                          </select>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Kapasitas</label>
                            <input type="number" name="capacity" value={utilizationForm.capacity} onChange={handleUtilizationChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-1.5">Terisi</label>
                            <input type="number" name="used" value={utilizationForm.used} onChange={handleUtilizationChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required />
                          </div>
                        </div>
                        <button type="submit" className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition-all">Simpan Data</button>
                      </form>
                    </Card>
                  </div>
                  <div className="lg:col-span-2">
                    <Card className="h-full">
                      <h3 className="text-lg font-bold text-slate-800 mb-4">Riwayat Input Utilisasi</h3>
                      <div className="overflow-x-auto rounded-lg border border-slate-100 max-h-[600px]">
                        <table className="w-full text-sm text-left">
                          <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 sticky top-0">
                            <tr><th className="px-4 py-3">Periode</th><th className="px-4 py-3">Zona</th><th className="px-4 py-3 text-right">Kapasitas</th><th className="px-4 py-3 text-right">Terisi</th><th className="px-4 py-3 text-right">Utilisasi</th><th className="px-4 py-3 text-center">Aksi</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {utilizationData.map(item => {
                              const util = item.capacity > 0 ? (item.used / item.capacity * 100).toFixed(1) : 0;
                              return (
                                <tr key={item.id} className="hover:bg-slate-50">
                                  <td className="px-4 py-3">{item.period}</td>
                                  <td className="px-4 py-3"><span className="bg-emerald-50 text-emerald-700 px-2 py-1 rounded text-xs font-bold">{item.zone}</span></td>
                                  <td className="px-4 py-3 text-right">{item.capacity}</td>
                                  <td className="px-4 py-3 text-right">{item.used}</td>
                                  <td className="px-4 py-3 text-right font-bold">{util}%</td>
                                  <td className="px-4 py-3 text-center"><button onClick={() => handleDelete(item.id, 'utilization')} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </Card>
                  </div>
                </>
              )}

              {/* DAMAGE ADMIN - DIKEMBALIKAN */}
              {adminSection === 'damage' && (
                <>
                  <div className="lg:col-span-1 space-y-6">
                    <Card className="bg-white border-red-100 shadow-md">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="bg-red-600 p-2.5 rounded-xl text-white shadow-lg"><AlertTriangle size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Input Damage Rate</h2>
                      </div>
                      <form onSubmit={handleDamageSubmit} className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Bulan</label>
                          <select name="month" value={damageForm.month} onChange={handleDamageChange} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                            {months.map(m => <option key={m} value={m}>{m}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Total Handling</label>
                          <input type="number" name="handling" value={damageForm.handling} onChange={handleDamageChange} placeholder="Total barang diproses" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-red-500" required />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-700 mb-1.5">Total Damage</label>
                          <input type="number" name="damage" value={damageForm.damage} onChange={handleDamageChange} placeholder="Total barang rusak" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-red-500" required />
                        </div>
                        <button type="submit" className="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition-all">Simpan Data</button>
                      </form>
                    </Card>
                  </div>
                  <div className="lg:col-span-2">
                    <Card className="h-full">
                      <h3 className="text-lg font-bold text-slate-800 mb-4">Riwayat Input Damage</h3>
                      <div className="overflow-x-auto rounded-lg border border-slate-100 max-h-[600px]">
                        <table className="w-full text-sm text-left">
                          <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 sticky top-0">
                            <tr><th className="px-4 py-3">Bulan</th><th className="px-4 py-3 text-right">Handling</th><th className="px-4 py-3 text-right">Damage</th><th className="px-4 py-3 text-right">Rate</th><th className="px-4 py-3 text-center">Aksi</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {damageData.map(item => {
                              const rate = item.handling > 0 ? ((item.damage / item.handling) * 100).toFixed(3) : 0;
                              return (
                                <tr key={item.id} className="hover:bg-slate-50">
                                  <td className="px-4 py-3 font-medium">{item.month}</td>
                                  <td className="px-4 py-3 text-right">{item.handling}</td>
                                  <td className="px-4 py-3 text-right text-red-600">{item.damage}</td>
                                  <td className="px-4 py-3 text-right font-bold">{rate}%</td>
                                  <td className="px-4 py-3 text-center"><button onClick={() => handleDelete(item.id, 'damage')} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button></td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </Card>
                  </div>
                </>
              )}

              {/* PALLET ADMIN - DIKEMBALIKAN */}
              {adminSection === 'pallet' && (
                <>
                  <div className="lg:col-span-1 space-y-6">
                    <Card className="bg-white border-amber-100 shadow-md">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="bg-amber-600 p-2.5 rounded-xl text-white shadow-lg"><RotateCcw size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Input Pallet</h2>
                      </div>
                      <div className="space-y-6">
                        {/* Manual Input Form */}
                        <form onSubmit={handlePalletSubmit} className="space-y-4 border-b border-amber-100 pb-6">
                          <h4 className="text-sm font-bold text-amber-800 uppercase tracking-wider">Manual Input</h4>
                          <div>
                             <label className="block text-sm font-semibold text-slate-700 mb-1.5">Bulan</label>
                             <select name="month" value={palletForm.month} onChange={handlePalletChange} className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-amber-500">{months.map(m => <option key={m} value={m}>{m}</option>)}</select>
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                             <div><label className="text-xs font-semibold text-slate-500">Ret '25</label><input type="number" name="returned25" value={palletForm.returned25} onChange={handlePalletChange} className="w-full p-2 border rounded-lg" placeholder="0"/></div>
                             <div><label className="text-xs font-semibold text-slate-500">Ret '26</label><input type="number" name="returned26" value={palletForm.returned26} onChange={handlePalletChange} className="w-full p-2 border rounded-lg" placeholder="0"/></div>
                             <div><label className="text-xs font-semibold text-slate-500">Out '25</label><input type="number" name="outgoing25" value={palletForm.outgoing25} onChange={handlePalletChange} className="w-full p-2 border rounded-lg" placeholder="0"/></div>
                             <div><label className="text-xs font-semibold text-slate-500">Out '26</label><input type="number" name="outgoing26" value={palletForm.outgoing26} onChange={handlePalletChange} className="w-full p-2 border rounded-lg" placeholder="0"/></div>
                          </div>
                          <button type="submit" className="w-full bg-amber-600 text-white py-2 rounded-lg font-bold hover:bg-amber-700">Simpan Manual</button>
                        </form>

                        {/* Bulk Input */}
                        <div className="space-y-3">
                          <h4 className="text-sm font-bold text-amber-800 uppercase tracking-wider">Bulk Upload</h4>
                          <textarea value={palletBulkText} onChange={(e) => handlePalletBulkParse(e.target.value)} placeholder="Format: No | Bulan | Ret25 | Ret26 | Out25 | Out26" className="w-full h-24 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono" />
                          <button onClick={() => saveBatchToFirebase('pallet_return', palletBulkPreview, "Bulk Pallet Saved!", () => { setPalletBulkText(''); setPalletBulkPreview([]); })} disabled={palletBulkPreview.length === 0 || isProcessing} className={`w-full py-2 rounded-lg font-bold text-white text-sm ${palletBulkPreview.length > 0 ? 'bg-amber-600 hover:bg-amber-700' : 'bg-slate-300'}`}>
                            {isProcessing ? <Loader2 className="animate-spin inline mr-1" size={14} /> : <UploadCloud className="inline mr-1" size={14} />} Upload {palletBulkPreview.length} Items
                          </button>
                        </div>
                      </div>
                    </Card>
                  </div>
                  <div className="lg:col-span-2">
                    <Card className="h-full">
                       <h3 className="text-lg font-bold text-slate-800 mb-4">Database Pallet</h3>
                       <div className="overflow-x-auto rounded-lg border border-slate-100 max-h-[600px]">
                         <table className="w-full text-xs text-left">
                           <thead className="bg-slate-50 text-slate-500 sticky top-0"><tr><th className="px-3 py-2">Bulan</th><th className="px-3 py-2 text-right">Ret '26</th><th className="px-3 py-2 text-right">Out '26</th><th className="px-3 py-2 text-center">Aksi</th></tr></thead>
                           <tbody>
                             {palletReturnData.map(item => (
                               <tr key={item.id} className="hover:bg-slate-50 border-b border-slate-50">
                                 <td className="px-3 py-2 font-medium">{item.month}</td>
                                 <td className="px-3 py-2 text-right">{item.returned26 || item.returned}</td>
                                 <td className="px-3 py-2 text-right">{item.outgoing26 || item.outgoing}</td>
                                 <td className="px-3 py-2 text-center"><button onClick={() => handleDelete(item.id, 'pallet')} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button></td>
                               </tr>
                             ))}
                           </tbody>
                         </table>
                       </div>
                    </Card>
                  </div>
                </>
              )}

              {/* MASTER DATA ADMIN - DIKEMBALIKAN */}
              {adminSection === 'master' && (
                <>
                  <div className="lg:col-span-1 space-y-6">
                    <Card className="bg-white border-teal-100 shadow-md">
                      <div className="flex items-center gap-3 mb-6">
                        <div className="bg-teal-600 p-2.5 rounded-xl text-white shadow-lg"><Database size={20} /></div>
                        <h2 className="text-xl font-bold text-slate-800">Master Data Pallet</h2>
                      </div>
                      <div className="space-y-4">
                        <label className="block text-sm font-semibold text-slate-700">Paste Excel (Material | Unit | MatNum | ... | P-to-Zak | P-to-Ton)</label>
                        <textarea value={masterBulkText} onChange={(e) => handleMasterBulkParse(e.target.value)} placeholder="121-701 | ZAK | FG-700 | ... | 40 | 2" className="w-full h-48 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono outline-none focus:ring-2 focus:ring-teal-500" />
                        <button onClick={() => saveBatchToFirebase('master_data_pallet', masterBulkPreview, "Master Data Saved!", () => { setMasterBulkText(''); setMasterBulkPreview([]); })} disabled={masterBulkPreview.length === 0 || isProcessing} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg flex justify-center items-center gap-2 ${masterBulkPreview.length > 0 ? 'bg-teal-600 hover:bg-teal-700' : 'bg-slate-300'}`}>
                          {isProcessing ? <Loader2 className="animate-spin" /> : <UploadCloud />} Simpan {masterBulkPreview.length} Data
                        </button>
                      </div>
                    </Card>
                  </div>
                  <div className="lg:col-span-2">
                    <Card className="h-full">
                       <h3 className="text-lg font-bold text-slate-800 mb-4">Preview Master Data</h3>
                       <div className="overflow-x-auto rounded-lg border border-teal-100 max-h-[600px]">
                         <table className="w-full text-xs text-left">
                           <thead className="bg-teal-100 text-teal-800 font-semibold sticky top-0"><tr><th className="px-3 py-2">Material</th><th className="px-3 py-2">Mat Num</th><th className="px-3 py-2 text-right">P-to-Zak</th><th className="px-3 py-2 text-right">P-to-Ton</th></tr></thead>
                           <tbody>
                             {(masterBulkPreview.length > 0 ? masterBulkPreview : masterData.slice(0, 50)).map((item, idx) => (
                               <tr key={idx} className="border-b border-teal-50 hover:bg-teal-50">
                                 <td className="px-3 py-1 font-mono">{item.material}</td>
                                 <td className="px-3 py-1 font-mono">{item.matNum}</td>
                                 <td className="px-3 py-1 text-right">{item.pToZak}</td>
                                 <td className="px-3 py-1 text-right">{item.pToTon}</td>
                               </tr>
                             ))}
                             {masterBulkPreview.length === 0 && masterData.length === 0 && <tr><td colSpan="4" className="text-center py-4 text-slate-400">Belum ada data</td></tr>}
                           </tbody>
                         </table>
                       </div>
                    </Card>
                  </div>
                </>
              )}
            </div>
          </div>
        )}

      </div>
    </div>
  );
}
